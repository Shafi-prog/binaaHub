<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Final Authentication Test - SSR Version</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .step {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #007acc;
      }
      .success {
        border-left-color: #28a745;
      }
      .error {
        border-left-color: #dc3545;
      }
      .warning {
        border-left-color: #ffc107;
      }
      #output {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      button {
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #005999;
      }
      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
        font-size: 12px;
        margin-left: 10px;
      }
      .status.success {
        background: #28a745;
      }
      .status.error {
        background: #dc3545;
      }
      .status.pending {
        background: #6c757d;
      }
    </style>
  </head>
  <body>
    <h1>üîß Final Authentication Test - SSR Version</h1>
    <p>Testing the complete authentication flow with the new Supabase SSR implementation.</p>

    <div class="step">
      <h3>Test Configuration</h3>
      <p><strong>Server:</strong> http://localhost:3000</p>
      <p><strong>Test User:</strong> store@store.com</p>
      <p><strong>Implementation:</strong> @supabase/ssr with createServerClient</p>
    </div>

    <div class="step">
      <button onclick="runCompleteTest()">üöÄ Run Complete Authentication Test</button>
      <button onclick="testQuickLogin()">‚ö° Quick Login Test</button>
      <button onclick="testMiddleware()">üõ°Ô∏è Test Middleware Only</button>
      <button onclick="clearOutput()">üßπ Clear Output</button>
    </div>

    <div class="step">
      <h3>Test Results</h3>
      <div id="output">Ready to test...</div>
    </div>

    <script>
      const BASE_URL = 'http://localhost:3000';
      const TEST_USER = { email: 'store@store.com', password: '123456' };

      function log(message, type = 'info') {
        const output = document.getElementById('output');
        const timestamp = new Date().toLocaleTimeString();
        const typeEmoji = {
          info: '‚ÑπÔ∏è',
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          step: 'üîπ',
        };

        output.textContent += `[${timestamp}] ${typeEmoji[type]} ${message}\n`;
        output.scrollTop = output.scrollHeight;
      }

      function clearOutput() {
        document.getElementById('output').textContent = 'Output cleared...\n';
      }

      async function testQuickLogin() {
        log('Quick Login Test Started', 'step');

        try {
          const response = await fetch(`${BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(TEST_USER),
          });

          log(`Login API Status: ${response.status}`);

          if (response.ok) {
            const data = await response.json();
            log(`Login Success: ${data.user.email} (${data.user.account_type})`, 'success');
            log(`Redirect URL: ${data.redirectTo}`);

            // Check cookies
            const cookies = document.cookie;
            log(`Browser Cookies: ${cookies ? 'Present' : 'None'}`);
          } else {
            const error = await response.text();
            log(`Login Failed: ${error}`, 'error');
          }
        } catch (error) {
          log(`Quick Login Error: ${error.message}`, 'error');
        }
      }

      async function testMiddleware() {
        log('Middleware Test Started', 'step');

        try {
          // Test accessing protected route
          const response = await fetch(`${BASE_URL}/store/dashboard`, {
            redirect: 'manual',
          });

          log(`Middleware Response Status: ${response.status}`);

          if (response.status === 302 || response.status === 307) {
            const location = response.headers.get('location');
            log(`Middleware Redirect: ${location}`);

            if (location && location.includes('/login')) {
              log('Middleware correctly blocking unauthenticated access', 'success');
            } else {
              log('Unexpected redirect location', 'warning');
            }
          } else if (response.status === 200) {
            log('Protected route accessible (user is authenticated)', 'success');
          } else {
            log(`Unexpected middleware response: ${response.status}`, 'warning');
          }
        } catch (error) {
          log(`Middleware Test Error: ${error.message}`, 'error');
        }
      }

      async function runCompleteTest() {
        log('='.repeat(60), 'step');
        log('COMPLETE AUTHENTICATION FLOW TEST - SSR VERSION', 'step');
        log('='.repeat(60), 'step');

        try {
          // Step 1: Login
          log('\nüîê Step 1: Authentication Test', 'step');
          const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(TEST_USER),
            credentials: 'include',
          });

          log(`Login Status: ${loginResponse.status}`);

          if (!loginResponse.ok) {
            const error = await loginResponse.text();
            log(`Login Failed: ${error}`, 'error');
            return;
          }

          const loginData = await loginResponse.json();
          log(`‚úÖ Login Success: ${loginData.user.email}`, 'success');
          log(`Account Type: ${loginData.user.account_type}`);
          log(`Redirect URL: ${loginData.redirectTo}`);

          // Check Set-Cookie headers
          const setCookieHeader = loginResponse.headers.get('set-cookie');
          log(`Set-Cookie Header: ${setCookieHeader ? 'Present' : 'None'}`);

          // Wait a moment for cookies to be set
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Step 2: Test middleware with credentials
          log('\nüõ°Ô∏è Step 2: Middleware Authentication Test', 'step');
          const protectedResponse = await fetch(`${BASE_URL}${loginData.redirectTo}`, {
            credentials: 'include',
            redirect: 'manual',
          });

          log(`Protected Route Status: ${protectedResponse.status}`);

          if (protectedResponse.status === 302 || protectedResponse.status === 307) {
            const redirectLocation = protectedResponse.headers.get('location');
            log(`Middleware Redirect: ${redirectLocation}`);

            if (redirectLocation && redirectLocation.includes('/login')) {
              log('‚ùå AUTHENTICATION FAILED: Middleware redirected to login', 'error');
              log('This indicates cookies are not being transmitted properly', 'error');

              // Step 3: Debug cookies
              log('\nüîç Step 3: Cookie Debug', 'step');
              const debugResponse = await fetch(`${BASE_URL}/api/check-cookies`, {
                credentials: 'include',
              });

              if (debugResponse.ok) {
                const debugData = await debugResponse.json();
                log(`Server-side cookies: ${debugData.total} found`);
                debugData.cookies.forEach((cookie) => {
                  log(`  - ${cookie.name}: ${cookie.value.substring(0, 20)}...`);
                });
              }
            } else {
              log('Middleware redirect (possibly to correct dashboard)', 'warning');
            }
          } else if (protectedResponse.status === 200) {
            log('üéâ SUCCESS: Protected route accessible!', 'success');
            log('‚úÖ Authentication flow is working correctly!', 'success');
          } else {
            log(`Unexpected response: ${protectedResponse.status}`, 'warning');
          }

          // Step 4: Browser cookies check
          log('\nüç™ Step 4: Browser Cookies Check', 'step');
          const browserCookies = document.cookie;
          if (browserCookies) {
            log(`Browser cookies found: ${browserCookies.split(';').length} cookies`);
            browserCookies.split(';').forEach((cookie) => {
              const [name] = cookie.trim().split('=');
              if (name.includes('sb-') || name.includes('supabase') || name.includes('auth')) {
                log(`  Auth cookie: ${name}`);
              }
            });
          } else {
            log('No cookies found in browser', 'warning');
          }
        } catch (error) {
          log(`Complete Test Error: ${error.message}`, 'error');
          console.error('Full error:', error);
        }

        log('\nüèÅ Test Complete', 'step');
      }

      // Auto-run a quick test when page loads
      window.addEventListener('load', () => {
        log('Page loaded. Ready for testing.', 'info');
        log('Click "Run Complete Authentication Test" to start.', 'info');
      });
    </script>
  </body>
</html>
