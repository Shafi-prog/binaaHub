(()=>{var e={};e.id=3633,e.ids=[3633],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},23870:(e,t,r)=>{"use strict";r.d(t,{A:()=>u});var s=r(55511);let n={randomUUID:s.randomUUID},a=new Uint8Array(256),i=a.length,o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));let u=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();let u=(e=e||{}).random??e.rng?.()??(i>a.length-16&&((0,s.randomFillSync)(a),i=0),a.slice(i,i+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=u[e];return t}return function(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}(u)}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78309:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>f,serverHooks:()=>_,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>p});var n=r(96559),a=r(48088),i=r(37719),o=r(32190),u=r(61223),d=r(44999),c=r(23870);async function p(e){try{let t,r=(0,u.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:s},error:n}=await r.auth.getUser();if(n||!s)return o.NextResponse.json({error:"Unauthorized"},{status:401});let a=await e.formData(),i=a.get("userId"),p=a.get("supervisorId"),f=a.get("projectId"),h=a.get("content"),g=a.get("attachment");if(!i||!h||!p&&!f)return o.NextResponse.json({error:"Missing required parameters"},{status:400});let _=await l(r,s.id);t=_?i:p;let x=null;if(g){let e=g.name.split(".").pop(),t=`${(0,c.A)()}.${e}`,s=`chat-attachments/${t}`,{data:n,error:a}=await r.storage.from("attachments").upload(s,g,{cacheControl:"3600",upsert:!1});if(a)return o.NextResponse.json({error:"Failed to upload attachment"},{status:500});let{data:{publicUrl:i}}=r.storage.from("attachments").getPublicUrl(s);x=i}let{data:y}=await r.from("profiles").select("full_name").eq("id",s.id).single(),w=y?.full_name||s.email,v={id:(0,c.A)(),user_id:_?t:i,supervisor_id:_?s.id:p,project_id:f||null,sender_id:s.id,sender_type:_?"supervisor":"user",sender_name:w,recipient_id:t,content:h,attachment_url:x,read:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:q,error:U}=await r.from("supervisor_chat_messages").insert(v).select().single();if(U)return o.NextResponse.json({error:"Failed to send message"},{status:500});let j={id:q.id,sender_id:q.sender_id,sender_type:q.sender_type,sender_name:q.sender_name,content:q.content,timestamp:q.created_at,attachment_url:q.attachment_url,read:q.read};return await m(r,t,w,f),o.NextResponse.json({message:j})}catch(e){return o.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function l(e,t){let{data:r}=await e.from("construction_supervisors").select("id").eq("user_id",t).maybeSingle();return!!r}async function m(e,t,r,s){try{let n=s?`لديك رسالة جديدة من ${r} بخصوص المشروع`:`لديك رسالة جديدة من ${r}`;await e.from("system_notifications").insert({user_id:t,title:"رسالة جديدة",message:n,type:"info",category:"chat",related_entity_type:"chat",related_entity_id:s||null,is_read:!1,created_at:new Date().toISOString()})}catch(e){}}let f=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/chat/send/route",pathname:"/api/chat/send",filename:"route",bundlePath:"app/api/chat/send/route"},resolvedPagePath:"C:\\Users\\hp\\BinnaCodes\\binna\\src\\app\\api\\chat\\send\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:g,serverHooks:_}=f;function x(){return(0,i.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:g})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,580,9398,1223,4999],()=>r(78309));module.exports=s})();