(()=>{var e={};e.id=5039,e.ids=[5039],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},23870:(e,r,t)=>{"use strict";t.d(r,{A:()=>u});var s=t(55511);let i={randomUUID:s.randomUUID},o=new Uint8Array(256),a=o.length,n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));let u=function(e,r,t){if(i.randomUUID&&!r&&!e)return i.randomUUID();let u=(e=e||{}).random??e.rng?.()??(a>o.length-16&&((0,s.randomFillSync)(o),a=0),o.slice(a,a+=16));if(u.length<16)throw Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,r){if((t=t||0)<0||t+16>r.length)throw RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[t+e]=u[e];return r}return function(e,r=0){return(n[e[r+0]]+n[e[r+1]]+n[e[r+2]]+n[e[r+3]]+"-"+n[e[r+4]]+n[e[r+5]]+"-"+n[e[r+6]]+n[e[r+7]]+"-"+n[e[r+8]]+n[e[r+9]]+"-"+n[e[r+10]]+n[e[r+11]]+n[e[r+12]]+n[e[r+13]]+n[e[r+14]]+n[e[r+15]]).toLowerCase()}(u)}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=51906,e.exports=r},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},65352:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>j,routeModule:()=>f,serverHooks:()=>w,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{GET:()=>c,POST:()=>_});var i=t(96559),o=t(48088),a=t(37719),n=t(32190),u=t(61223),d=t(44999),p=t(23870);async function c(e){try{let r=(0,u.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:t},error:s}=await r.auth.getUser();if(s||!t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let i=e.nextUrl.searchParams,o=i.get("userId"),a=i.get("supervisorId"),p=i.get("status");if(!o&&!a)return n.NextResponse.json({error:"Missing userId or supervisorId parameter"},{status:400});let c=r.from("supervisor_requests").select(`
        id,
        user_id,
        supervisor_id,
        project_id,
        project:projects(name),
        request_type,
        description,
        budget_range_min,
        budget_range_max,
        preferred_start_date,
        duration_weeks,
        status,
        supervisor_response,
        created_at,
        updated_at
      `);if(o&&(c=c.eq("user_id",o)),a){let{data:e}=await r.from("construction_supervisors").select("id").eq("user_id",a).single();if(!e)return n.NextResponse.json({requests:[]});c=c.eq("supervisor_id",e.id)}p&&"all"!==p&&(c=c.eq("status",p));let{data:_,error:l}=await c.order("created_at",{ascending:!1});if(l)return n.NextResponse.json({error:"Failed to fetch requests"},{status:500});let v=_?.map(e=>({id:e.id,user_id:e.user_id,supervisor_id:e.supervisor_id,project_id:e.project_id,project_name:e.project&&e.project[0]?e.project[0].name:"Unknown Project",request_type:e.request_type,description:e.description,budget:e.budget_range_min,currency:"SAR",estimated_duration:e.duration_weeks?`${e.duration_weeks} weeks`:void 0,status:e.status,created_at:e.created_at,updated_at:e.updated_at,supervisor_response:e.supervisor_response?JSON.parse(e.supervisor_response):void 0}))||[];return n.NextResponse.json({requests:v})}catch(e){return n.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function _(e){try{let r=(0,u.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:t},error:s}=await r.auth.getUser();if(s||!t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let i=await e.json(),{action:o}=i;switch(o){case"create":return await l(r,t.id,i);case"respond":return await v(r,t.id,i);case"update-status":return await g(r,t.id,i);default:return n.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return n.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function l(e,r,t){let{project_id:s,request_type:i,description:o,budget:a,estimated_duration:u,supervisorId:d}=t;if(!s||!i||!o)return n.NextResponse.json({error:"Missing required fields"},{status:400});let{data:c}=await e.from("projects").select("name").eq("id",s).single(),_=null;if(d){let{data:r}=await e.from("construction_supervisors").select("id").eq("user_id",d).single();_=r?.id}let l=(0,p.A)(),v={id:l,user_id:r,supervisor_id:_,project_id:s,request_type:i,description:o,budget_range_min:a||null,budget_range_max:null,duration_weeks:u?parseInt(u):null,status:"pending",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{data:g,error:f}=await e.from("supervisor_requests").insert(v).select().single();if(f)return n.NextResponse.json({error:"Failed to create request"},{status:500});if(_){let{data:r}=await e.from("construction_supervisors").select("user_id").eq("id",_).single();r&&await e.from("system_notifications").insert({user_id:r.user_id,title:"طلب إشراف جديد",message:`لديك طلب إشراف جديد على مشروع ${c?.name||"جديد"}`,type:"info",category:"supervisor_request",related_entity_type:"supervisor_request",related_entity_id:l,is_read:!1,created_at:new Date().toISOString()})}let q={id:g.id,user_id:g.user_id,supervisor_id:g.supervisor_id,project_id:g.project_id,project_name:c?.name||"Unknown Project",request_type:g.request_type,description:g.description,budget:g.budget_range_min,currency:"SAR",estimated_duration:g.duration_weeks?`${g.duration_weeks} weeks`:void 0,status:g.status,created_at:g.created_at,updated_at:g.updated_at,supervisor_response:void 0};return n.NextResponse.json({request:q})}async function v(e,r,t){let{requestId:s,amount:i,duration:o,message:a}=t;if(!s||!i||!o||!a)return n.NextResponse.json({error:"Missing required fields"},{status:400});let{data:u}=await e.from("construction_supervisors").select("id").eq("user_id",r).single();if(!u)return n.NextResponse.json({error:"User is not a supervisor"},{status:403});let{data:d}=await e.from("supervisor_requests").select("id, user_id, project_id").eq("id",s).eq("supervisor_id",u.id).single();if(!d)return n.NextResponse.json({error:"Request not found or not assigned to this supervisor"},{status:404});let{data:p,error:c}=await e.from("supervisor_requests").update({supervisor_response:JSON.stringify({amount:i,duration:o,message:a}),updated_at:new Date().toISOString()}).eq("id",s).select().single();if(c)return n.NextResponse.json({error:"Failed to respond to request"},{status:500});await e.from("system_notifications").insert({user_id:d.user_id,title:"رد على طلب الإشراف",message:"تم الرد على طلب الإشراف الخاص بك",type:"info",category:"supervisor_request",related_entity_type:"supervisor_request",related_entity_id:s,is_read:!1,created_at:new Date().toISOString()});let{data:_}=await e.from("projects").select("name").eq("id",d.project_id).single(),l={id:p.id,user_id:p.user_id,supervisor_id:p.supervisor_id,project_id:p.project_id,project_name:_?.name||"Unknown Project",request_type:p.request_type,description:p.description,budget:p.budget_range_min,currency:"SAR",estimated_duration:p.duration_weeks?`${p.duration_weeks} weeks`:void 0,status:p.status,created_at:p.created_at,updated_at:p.updated_at,supervisor_response:p.supervisor_response?JSON.parse(p.supervisor_response):void 0};return n.NextResponse.json({request:l})}async function g(e,r,t){let{requestId:s,status:i,response:o}=t;if(!s||!i)return n.NextResponse.json({error:"Missing required fields"},{status:400});if(!["approved","rejected","in_progress","completed","cancelled"].includes(i))return n.NextResponse.json({error:"Invalid status value"},{status:400});let{data:a}=await e.from("supervisor_requests").select("id, supervisor_id, project_id").eq("id",s).eq("user_id",r).single();if(!a)return n.NextResponse.json({error:"Request not found or not owned by this user"},{status:404});let{data:u,error:d}=await e.from("supervisor_requests").update({status:i,updated_at:new Date().toISOString()}).eq("id",s).select().single();if(d)return n.NextResponse.json({error:"Failed to update request status"},{status:500});if(a.supervisor_id){let{data:r}=await e.from("construction_supervisors").select("user_id").eq("id",a.supervisor_id).single();if(r){let t,o;switch(i){case"approved":t="تمت الموافقة على طلب الإشراف",o="تمت الموافقة على عرضك للإشراف";break;case"rejected":t="تم رفض طلب الإشراف",o="تم رفض عرضك للإشراف";break;case"in_progress":t="تم بدء العمل على المشروع",o="تم تحديث حالة طلب الإشراف إلى قيد التنفيذ";break;case"completed":t="تم اكتمال المشروع",o="تم تحديث حالة طلب الإشراف إلى مكتمل";break;case"cancelled":t="تم إلغاء طلب الإشراف",o="تم إلغاء طلب الإشراف"}await e.from("system_notifications").insert({user_id:r.user_id,title:t,message:o,type:"info",category:"supervisor_request",related_entity_type:"supervisor_request",related_entity_id:s,is_read:!1,created_at:new Date().toISOString()})}}let{data:p}=await e.from("projects").select("name").eq("id",a.project_id).single(),c={id:u.id,user_id:u.user_id,supervisor_id:u.supervisor_id,project_id:u.project_id,project_name:p?.name||"Unknown Project",request_type:u.request_type,description:u.description,budget:u.budget_range_min,currency:"SAR",estimated_duration:u.duration_weeks?`${u.duration_weeks} weeks`:void 0,status:u.status,created_at:u.created_at,updated_at:u.updated_at,supervisor_response:o||u.supervisor_response};return n.NextResponse.json({request:c})}let f=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/supervisor-requests/route",pathname:"/api/supervisor-requests",filename:"route",bundlePath:"app/api/supervisor-requests/route"},resolvedPagePath:"C:\\Users\\hp\\BinnaCodes\\binna\\src\\app\\api\\supervisor-requests\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:q,workUnitAsyncStorage:m,serverHooks:w}=f;function j(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:m})}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,580,9398,1223,4999],()=>t(65352));module.exports=s})();