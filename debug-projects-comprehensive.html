<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects Debug Test - Authentication & Database</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; }
        .auth-form { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .auth-form input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Projects Debug Test - Complete Authentication & Database Check</h1>
        
        <!-- Authentication Section -->
        <div class="test-section">
            <h2>üîê Authentication</h2>
            
            <div class="auth-form">
                <input type="email" id="email" placeholder="Email (test@example.com)" value="test@example.com">
                <input type="password" id="password" placeholder="Password" value="testpassword123">
                <button onclick="signUp()">Sign Up</button>
                <button onclick="signIn()">Sign In</button>
                <button onclick="signOut()">Sign Out</button>
                <button onclick="checkAuth()">Check Auth</button>
            </div>
            
            <div id="auth-status" class="test-section info">
                <strong>Auth Status:</strong> Checking...
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="test-section">
            <h2>üìä Database Stats</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="projects-count">-</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="current-user">-</div>
                    <div class="stat-label">Current User</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="db-url">-</div>
                    <div class="stat-label">Database URL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="last-test">-</div>
                    <div class="stat-label">Last Test</div>
                </div>
            </div>
        </div>

        <!-- Project Operations -->
        <div class="test-section">
            <h2>üèóÔ∏è Project Operations</h2>
            
            <div style="margin: 10px 0;">
                <button onclick="testGetProjects()">Get Projects</button>
                <button onclick="testCreateProject()">Create Test Project</button>
                <button onclick="testGetRecentProjects()">Test getRecentProjects Function</button>
                <button onclick="testAPIEndpoint()">Test /api/projects Endpoint</button>
                <button onclick="clearProjects()">Clear Test Projects</button>
            </div>
            
            <div id="projects-result" class="test-section info">
                <strong>Projects Result:</strong> Not tested yet
            </div>
        </div>

        <!-- Database Raw Queries -->
        <div class="test-section">
            <h2>üîç Raw Database Queries</h2>
            
            <div style="margin: 10px 0;">
                <button onclick="testDirectQuery()">Direct Projects Query</button>
                <button onclick="testTableExists()">Check Tables Exist</button>
                <button onclick="testRLS()">Test RLS Policies</button>
                <button onclick="testAuth()">Test Auth State</button>
            </div>
            
            <div id="raw-query-result" class="test-section info">
                <strong>Raw Query Result:</strong> Not tested yet
            </div>
        </div>

        <!-- Detailed Log -->
        <div class="test-section">
            <h2>üìù Detailed Log</h2>
            <button onclick="clearLog()">Clear Log</button>
            <div id="detailed-log" class="log">Starting debug session...\n</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://lqhopwohuddhapkhhikf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxaG9wd29odWRkaGFwa2hoaWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njc1NjQsImV4cCI6MjA1OTU0MzU2NH0.Zze96fAMkynERwRFhyMF-F6_ds5WcwGckLD0qGQD9JQ';
        
        const { createClient } = supabase;
        const client = createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // Utility functions
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('detailed-log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, content, className = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `test-section ${className}`;
        }

        function updateStat(statId, value) {
            document.getElementById(statId).textContent = value;
        }

        function clearLog() {
            document.getElementById('detailed-log').textContent = 'Log cleared...\n';
        }

        // Authentication functions
        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log(`üîê Signing up user: ${email}`);
            
            try {
                const { data, error } = await client.auth.signUp({
                    email: email,
                    password: password,
                });

                if (error) {
                    log(`‚ùå Signup error: ${error.message}`);
                    updateStatus('auth-status', `<strong>Signup Error:</strong> ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Signup successful: ${data.user?.email || 'Unknown'}`);
                    updateStatus('auth-status', `<strong>Signup Success:</strong> ${data.user?.email} (Check email for confirmation)`, 'success');
                    currentUser = data.user;
                    updateStat('current-user', data.user?.email || 'Unknown');
                }
            } catch (e) {
                log(`üí• Signup exception: ${e.message}`);
                updateStatus('auth-status', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log(`üîê Signing in user: ${email}`);
            
            try {
                const { data, error } = await client.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    log(`‚ùå Signin error: ${error.message}`);
                    updateStatus('auth-status', `<strong>Signin Error:</strong> ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Signin successful: ${data.user?.email}`);
                    updateStatus('auth-status', `<strong>Signin Success:</strong> ${data.user?.email} (ID: ${data.user?.id})`, 'success');
                    currentUser = data.user;
                    updateStat('current-user', data.user?.email || 'Unknown');
                }
            } catch (e) {
                log(`üí• Signin exception: ${e.message}`);
                updateStatus('auth-status', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function signOut() {
            log('üîê Signing out...');
            
            try {
                const { error } = await client.auth.signOut();
                
                if (error) {
                    log(`‚ùå Signout error: ${error.message}`);
                } else {
                    log('‚úÖ Signout successful');
                    updateStatus('auth-status', '<strong>Status:</strong> Signed out', 'info');
                    currentUser = null;
                    updateStat('current-user', 'None');
                }
            } catch (e) {
                log(`üí• Signout exception: ${e.message}`);
            }
        }

        async function checkAuth() {
            log('üîç Checking authentication status...');
            
            try {
                const { data: { user }, error } = await client.auth.getUser();
                
                if (error) {
                    log(`‚ùå Auth check error: ${error.message}`);
                    updateStatus('auth-status', `<strong>Auth Error:</strong> ${error.message}`, 'error');
                } else if (user) {
                    log(`‚úÖ User authenticated: ${user.email} (ID: ${user.id})`);
                    updateStatus('auth-status', `<strong>Authenticated:</strong> ${user.email} (ID: ${user.id})`, 'success');
                    currentUser = user;
                    updateStat('current-user', user.email);
                } else {
                    log('‚ùå No authenticated user');
                    updateStatus('auth-status', '<strong>Status:</strong> Not authenticated', 'warning');
                    currentUser = null;
                    updateStat('current-user', 'None');
                }
            } catch (e) {
                log(`üí• Auth check exception: ${e.message}`);
                updateStatus('auth-status', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        // Project operation functions
        async function testGetProjects() {
            log('üìã Testing get projects...');
            
            if (!currentUser) {
                log('‚ùå No authenticated user');
                updateStatus('projects-result', '<strong>Error:</strong> Must be authenticated', 'error');
                return;
            }
            
            try {
                const { data: projects, error } = await client
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) {
                    log(`‚ùå Get projects error: ${error.message}`);
                    updateStatus('projects-result', `<strong>Error:</strong> ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Found ${projects?.length || 0} projects`);
                    updateStatus('projects-result', `<strong>Success:</strong> Found ${projects?.length || 0} projects`, 'success');
                    updateStat('projects-count', projects?.length || 0);
                    
                    if (projects && projects.length > 0) {
                        log('üìã Projects:');
                        projects.forEach((p, i) => {
                            log(`   ${i + 1}. ${p.name} (${p.id}) - Status: ${p.status}`);
                        });
                    }
                }
            } catch (e) {
                log(`üí• Get projects exception: ${e.message}`);
                updateStatus('projects-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function testCreateProject() {
            log('üèóÔ∏è Testing create project...');
            
            if (!currentUser) {
                log('‚ùå No authenticated user');
                updateStatus('projects-result', '<strong>Error:</strong> Must be authenticated', 'error');
                return;
            }
            
            const testProject = {
                user_id: currentUser.id,
                name: `Test Project ${Date.now()}`,
                description: 'A test project created from debug interface',
                project_type: 'residential',
                location: 'Test Location, Saudi Arabia',
                status: 'planning',
                priority: 'medium',
                budget: 100000,
                currency: 'SAR',
                progress_percentage: 0,
                is_active: true
            };
            
            try {
                log('üìù Creating project with data: ' + JSON.stringify(testProject, null, 2));
                
                const { data: project, error } = await client
                    .from('projects')
                    .insert(testProject)
                    .select()
                    .single();

                if (error) {
                    log(`‚ùå Create project error: ${error.message}`);
                    log('Error details: ' + JSON.stringify(error, null, 2));
                    updateStatus('projects-result', `<strong>Create Error:</strong> ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Project created successfully: ${project.name} (${project.id})`);
                    updateStatus('projects-result', `<strong>Success:</strong> Created project "${project.name}" (${project.id})`, 'success');
                    
                    // Refresh project count
                    testGetProjects();
                }
            } catch (e) {
                log(`üí• Create project exception: ${e.message}`);
                updateStatus('projects-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function testGetRecentProjects() {
            log('üìä Testing getRecentProjects function...');
            
            if (!currentUser) {
                log('‚ùå No authenticated user');
                updateStatus('projects-result', '<strong>Error:</strong> Must be authenticated', 'error');
                return;
            }
            
            try {
                // Simulate the getRecentProjects function logic
                const PAGE_SIZE = 5;
                const page = 1;
                const start = (page - 1) * PAGE_SIZE;
                
                log(`üîç Parameters: userId=${currentUser.id}, page=${page}, start=${start}, PAGE_SIZE=${PAGE_SIZE}`);
                
                // Get total count
                const { count, error: countError } = await client
                    .from('projects')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);

                if (countError) {
                    log(`‚ùå Count error: ${countError.message}`);
                    updateStatus('projects-result', `<strong>Count Error:</strong> ${countError.message}`, 'error');
                    return;
                }

                log(`üìä Total count: ${count}`);

                // Get paginated data
                const { data: projects, error } = await client
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .range(start, start + PAGE_SIZE - 1);

                if (error) {
                    log(`‚ùå Projects query error: ${error.message}`);
                    updateStatus('projects-result', `<strong>Query Error:</strong> ${error.message}`, 'error');
                    return;
                }

                const result = {
                    items: projects || [],
                    hasMore: count ? start + PAGE_SIZE < count : false,
                    total: count || 0,
                    page,
                };

                log(`‚úÖ getRecentProjects result: ${result.items.length} items, total: ${result.total}, hasMore: ${result.hasMore}`);
                updateStatus('projects-result', `<strong>getRecentProjects Success:</strong> ${result.items.length} items out of ${result.total} total`, 'success');
                updateStat('projects-count', result.total);
                
                if (result.items.length > 0) {
                    log('üìã Projects returned:');
                    result.items.forEach((p, i) => {
                        log(`   ${i + 1}. ${p.name} (${p.id}) - Created: ${p.created_at}`);
                    });
                }

            } catch (e) {
                log(`üí• getRecentProjects exception: ${e.message}`);
                updateStatus('projects-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function testAPIEndpoint() {
            log('üåê Testing /api/projects endpoint...');
            
            try {
                const response = await fetch('/api/projects', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                log(`üì° API Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå API Error: ${errorText}`);
                    updateStatus('projects-result', `<strong>API Error:</strong> ${response.status} - ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                log(`‚úÖ API Success: ${JSON.stringify(data, null, 2)}`);
                updateStatus('projects-result', `<strong>API Success:</strong> ${JSON.stringify(data)}`, 'success');

            } catch (e) {
                log(`üí• API exception: ${e.message}`);
                updateStatus('projects-result', `<strong>API Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function clearProjects() {
            log('üóëÔ∏è Clearing test projects...');
            
            if (!currentUser) {
                log('‚ùå No authenticated user');
                return;
            }
            
            try {
                // Delete projects that contain "Test Project" in the name
                const { data: deleted, error } = await client
                    .from('projects')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .like('name', '%Test Project%')
                    .select();

                if (error) {
                    log(`‚ùå Clear projects error: ${error.message}`);
                } else {
                    log(`‚úÖ Cleared ${deleted?.length || 0} test projects`);
                    testGetProjects(); // Refresh count
                }
            } catch (e) {
                log(`üí• Clear projects exception: ${e.message}`);
            }
        }

        // Raw database query functions
        async function testDirectQuery() {
            log('üîç Testing direct database query...');
            
            try {
                const { data: allProjects, error } = await client
                    .from('projects')
                    .select('*');

                if (error) {
                    log(`‚ùå Direct query error: ${error.message}`);
                    updateStatus('raw-query-result', `<strong>Error:</strong> ${error.message}`, 'error');
                } else {
                    log(`‚úÖ Direct query found ${allProjects?.length || 0} total projects (all users)`);
                    updateStatus('raw-query-result', `<strong>Success:</strong> ${allProjects?.length || 0} total projects`, 'success');
                }
            } catch (e) {
                log(`üí• Direct query exception: ${e.message}`);
                updateStatus('raw-query-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function testTableExists() {
            log('üîç Testing table existence...');
            
            const tablesToCheck = ['projects', 'orders', 'warranties', 'users'];
            let results = [];
            
            for (const table of tablesToCheck) {
                try {
                    const { data, error } = await client
                        .from(table)
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        log(`‚ùå Table '${table}': ${error.message}`);
                        results.push(`${table}: ERROR`);
                    } else {
                        log(`‚úÖ Table '${table}': EXISTS`);
                        results.push(`${table}: EXISTS`);
                    }
                } catch (e) {
                    log(`üí• Table '${table}': EXCEPTION - ${e.message}`);
                    results.push(`${table}: EXCEPTION`);
                }
            }
            
            updateStatus('raw-query-result', `<strong>Tables:</strong> ${results.join(', ')}`, 'info');
        }

        async function testRLS() {
            log('üîí Testing RLS policies...');
            
            try {
                // Test without authentication
                await client.auth.signOut();
                
                const { data: unauthData, error: unauthError } = await client
                    .from('projects')
                    .select('*')
                    .limit(1);
                
                if (unauthError) {
                    log(`‚úÖ RLS working: ${unauthError.message}`);
                    updateStatus('raw-query-result', `<strong>RLS Active:</strong> ${unauthError.message}`, 'success');
                } else {
                    log(`‚ö†Ô∏è RLS not working: Got ${unauthData?.length || 0} projects without auth`);
                    updateStatus('raw-query-result', `<strong>RLS Issue:</strong> Got data without auth`, 'warning');
                }
                
                // Restore authentication if we had it
                if (currentUser) {
                    await checkAuth();
                }
                
            } catch (e) {
                log(`üí• RLS test exception: ${e.message}`);
                updateStatus('raw-query-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        async function testAuth() {
            log('üîç Testing authentication state...');
            
            try {
                const { data: { session }, error: sessionError } = await client.auth.getSession();
                const { data: { user }, error: userError } = await client.auth.getUser();
                
                log(`Session: ${session ? 'EXISTS' : 'NONE'}`);
                log(`User: ${user ? user.email : 'NONE'}`);
                log(`Session Error: ${sessionError?.message || 'NONE'}`);
                log(`User Error: ${userError?.message || 'NONE'}`);
                
                const result = {
                    session: session ? 'EXISTS' : 'NONE',
                    user: user ? user.email : 'NONE',
                    sessionError: sessionError?.message || 'NONE',
                    userError: userError?.message || 'NONE'
                };
                
                updateStatus('raw-query-result', `<strong>Auth State:</strong> ${JSON.stringify(result)}`, 'info');
                
            } catch (e) {
                log(`üí• Auth test exception: ${e.message}`);
                updateStatus('raw-query-result', `<strong>Exception:</strong> ${e.message}`, 'error');
            }
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            log('üöÄ Page loaded, initializing...');
            updateStat('db-url', supabaseUrl.split('.')[0] + '...');
            updateStat('last-test', new Date().toLocaleTimeString());
            
            // Check initial auth state
            await checkAuth();
            
            log('‚úÖ Initialization complete');
        });

        // Update last test time periodically
        setInterval(() => {
            updateStat('last-test', new Date().toLocaleTimeString());
        }, 10000);
    </script>
</body>
</html>
