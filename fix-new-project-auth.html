<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ù…ØµØ§Ø¯Ù‚Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
        line-height: 1.6;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        border: 1px solid;
        position: relative;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      .info {
        background: #cce7ff;
        border-color: #b3d9ff;
        color: #004085;
      }
      button {
        padding: 12px 24px;
        margin: 8px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }
      button:hover {
        transform: translateY(-1px);
      }
      .btn-primary {
        background: #0066cc;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-info {
        background: #17a2b8;
        color: white;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      #log {
        background: #1e1e1e;
        color: #f8f8f2;
        border: 1px solid #444;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 13px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .test-section {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .test-section h3 {
        margin-top: 0;
        color: #495057;
      }
      .action-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ› ï¸ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ù…ØµØ§Ø¯Ù‚Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h1>

      <div class="status info">
        <strong>ğŸ¯ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯" ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„
        Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      </div>

      <div id="currentStatus" class="status warning">â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...</div>

      <div class="test-section">
        <h3>ğŸ” 1. ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</h3>
        <div class="action-group">
          <button onclick="checkAuthStatus()" class="btn-primary">ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</button>
          <button onclick="debugServerAuth()" class="btn-info">ØªØ´Ø®ÙŠØµ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</button>
          <button onclick="testProtectedRoutes()" class="btn-warning">
            Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©
          </button>
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ”§ 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h3>
        <div class="action-group">
          <button onclick="refreshSession()" class="btn-success">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©</button>
          <button onclick="syncCookies()" class="btn-info">Ù…Ø²Ø§Ù…Ù†Ø© Cookies</button>
          <button onclick="forceReauth()" class="btn-warning">Ø¥Ø¹Ø§Ø¯Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø³Ø±ÙŠØ©</button>
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ§ª 3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ù„</h3>
        <div class="action-group">
          <button onclick="testNewProjectAccess()" class="btn-success">
            Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          </button>
          <button onclick="simulateNewProjectClick()" class="btn-primary">
            Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯"
          </button>
        </div>
      </div>

      <div class="test-section">
        <h3>ğŸ“Š 4. Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø­Ù„ÙˆÙ„</h3>
        <div id="testResults"></div>
      </div>

      <div style="margin: 20px 0">
        <button onclick="clearLog()" class="btn-secondary">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        <button onclick="exportReport()" class="btn-info">ğŸ“‹ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>

      <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</h3>
      <div id="log"></div>
    </div>

    <script>
      const log = document.getElementById('log');
      const currentStatus = document.getElementById('currentStatus');
      const testResults = document.getElementById('testResults');

      let diagnosticData = {
        timestamp: new Date().toISOString(),
        tests: [],
        authState: null,
        serverState: null,
        solutions: [],
      };

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleString('ar-SA');
        const colors = {
          error: '#ff6b6b',
          success: '#51cf66',
          warning: '#ffd43b',
          info: '#74c0fc',
        };

        const coloredMessage = `<span style="color: ${colors[type] || '#f8f8f2'}">[${timestamp}] ${type.toUpperCase()}: ${message}</span>\n`;
        log.innerHTML += coloredMessage;
        log.scrollTop = log.scrollHeight;
        console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
      }

      function clearLog() {
        log.innerHTML = '';
        testResults.innerHTML = '';
        diagnosticData.tests = [];
      }

      function updateStatus(message, type) {
        currentStatus.className = `status ${type}`;
        currentStatus.innerHTML = message;
      }

      function addResult(title, status, details, solution = null) {
        const result = document.createElement('div');
        result.className = `status ${status}`;
        let content = `<strong>${title}:</strong> ${details}`;
        if (solution) {
          content += `<br><strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ${solution}`;
          diagnosticData.solutions.push({ title, solution });
        }
        result.innerHTML = content;
        testResults.appendChild(result);

        diagnosticData.tests.push({ title, status, details, solution });
      }

      async function checkAuthStatus() {
        addLog('ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©...');

        try {
          // Check client-side cookies
          const cookies = document.cookie;
          addLog(`ğŸª Ø¥Ø¬Ù…Ø§Ù„ÙŠ Cookies: ${cookies.split(';').length}`);

          // Check for Supabase auth cookies
          const authCookies = cookies
            .split(';')
            .filter((c) => c.includes('sb-') || c.includes('supabase') || c.includes('auth'));
          addLog(`ğŸ”‘ Auth Cookies: ${authCookies.length} Ù…ÙˆØ¬ÙˆØ¯Ø©`);

          if (authCookies.length === 0) {
            addResult(
              'ğŸª Auth Cookies',
              'error',
              'Ù„Ø§ ØªÙˆØ¬Ø¯ cookies Ù…ØµØ§Ø¯Ù‚Ø©',
              'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨'
            );
            return;
          }

          // Try to access a known working auth endpoint
          const authCheck = await fetch('/auth-diagnostic');
          const authText = await authCheck.text();

          if (authCheck.ok) {
            if (authText.includes('authenticated') || authText.includes('âœ…')) {
              addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'success', 'Ù…ØµØ§Ø¯Ù‚ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„');
              diagnosticData.authState = 'authenticated';
            } else {
              addResult(
                'ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©',
                'error',
                'ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„Ù‰ Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„',
                'Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„'
              );
              diagnosticData.authState = 'unauthenticated';
            }
          } else {
            addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error', `Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${authCheck.status}`);
          }

          updateStatus('âœ… ØªÙ… ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'info');
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error');
          addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function debugServerAuth() {
        addLog('ğŸ–¥ï¸ Ø¨Ø¯Ø¡ ØªØ´Ø®ÙŠØµ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…...');

        try {
          const response = await fetch('/api/debug-auth');
          const data = await response.json();

          addLog(`ğŸ“Š Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªØ´Ø®ÙŠØµ Ø§Ù„Ø®Ø§Ø¯Ù…: ${JSON.stringify(data, null, 2)}`);

          if (response.ok) {
            diagnosticData.serverState = data;

            if (data.session.exists && data.user.exists) {
              addResult(
                'ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…',
                'success',
                `Ù…ØµØ§Ø¯Ù‚ Ø¨Ù†Ø¬Ø§Ø­ - User: ${data.user.data?.email}`
              );
            } else if (data.session.exists && !data.user.exists) {
              addResult(
                'ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…',
                'warning',
                'Session Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙƒÙ† User ØºÙŠØ± Ù…ØªØ§Ø­',
                'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'
              );
            } else if (!data.session.exists && data.cookies.authCookies.length > 0) {
              addResult(
                'ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…',
                'error',
                'Cookies Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙƒÙ† Session ØºÙŠØ± ØµØ§Ù„Ø­Ø©',
                'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Cookies Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø®Ø§Ø¯Ù…'
              );
            } else {
              addResult(
                'ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…',
                'error',
                'Ù„Ø§ ØªÙˆØ¬Ø¯ session Ø£Ùˆ cookies ØµØ§Ù„Ø­Ø©',
                'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ø·Ù„ÙˆØ¨'
              );
            }
          } else {
            addResult('ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…', 'error', `Ø®Ø·Ø£ ÙÙŠ API: ${data.error}`);
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´Ø®ÙŠØµ Ø§Ù„Ø®Ø§Ø¯Ù…: ${error.message}`, 'error');
          addResult('ğŸ–¥ï¸ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Ø¯Ù…', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function testProtectedRoutes() {
        addLog('ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©...');

        const routes = ['/user/dashboard', '/user/projects', '/user/projects/new', '/user/profile'];

        for (const route of routes) {
          try {
            addLog(`ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ${route}...`);

            const response = await fetch(route, {
              method: 'GET',
              redirect: 'manual',
            });

            if (response.status === 200) {
              addLog(`âœ… ${route}: ÙˆØµÙˆÙ„ Ù†Ø§Ø¬Ø­`);
              if (route === '/user/projects/new') {
                addResult('ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'success', 'Ù…ØªØ§Ø­Ø© ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§!');
              }
            } else if (response.status === 307 || response.status === 302) {
              const location = response.headers.get('location');
              addLog(`ğŸ”„ ${route}: Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${location}`);

              if (route === '/user/projects/new' && location === '/login') {
                addResult(
                  'ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
                  'error',
                  'ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                  'Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©!'
                );
              }
            } else {
              addLog(`âŒ ${route}: Ø®Ø·Ø£ ${response.status}`);
            }
          } catch (error) {
            addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ${route}: ${error.message}`, 'error');
          }
        }
      }

      async function refreshSession() {
        addLog('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©...');

        try {
          // Try to refresh via auth refresh endpoint
          const response = await fetch('/api/auth/refresh', {
            method: 'POST',
          });

          if (response.ok) {
            const data = await response.json();
            addLog('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­');
            addResult('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©', 'success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­');

            // Test new project access after refresh
            setTimeout(() => testNewProjectAccess(), 1000);
          } else {
            addLog(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©: ${response.status}`);
            addResult('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©', 'error', `ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${response.status}`);
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©: ${error.message}`, 'error');
          addResult('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function syncCookies() {
        addLog('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø²Ø§Ù…Ù†Ø© Cookies...');

        try {
          // Force a page refresh to sync cookies
          window.location.reload();
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Cookies: ${error.message}`, 'error');
        }
      }

      async function forceReauth() {
        addLog('ğŸ” Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ù‚Ø³Ø±ÙŠØ©...');

        try {
          addResult('ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'info', 'Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error');
        }
      }

      async function testNewProjectAccess() {
        addLog('ğŸ†• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');

        try {
          const response = await fetch('/user/projects/new', {
            method: 'GET',
            redirect: 'manual',
          });

          if (response.status === 200) {
            addLog('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯!');
            addResult('âœ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©', 'success', 'ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†!');
          } else if (response.status === 307 || response.status === 302) {
            const location = response.headers.get('location');
            addLog(`âŒ Ù…Ø§ Ø²Ø§Ù„Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰: ${location}`);
            addResult(
              'âŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø³ØªÙ…Ø±Ø©',
              'error',
              `Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${location}`,
              'ÙŠØ¬Ø¨ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©'
            );
          } else {
            addLog(`âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${response.status}`);
            addResult('âŒ Ø®Ø·Ø£', 'error', `Ø®Ø·Ø£ HTTP ${response.status}`);
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`, 'error');
          addResult('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function simulateNewProjectClick() {
        addLog('ğŸ–±ï¸ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯"...');

        try {
          // First check if we're on dashboard
          const currentUrl = window.location.href;
          if (!currentUrl.includes('/dashboard')) {
            addResult(
              'ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ',
              'warning',
              'Ù„Ø³Øª ÙÙŠ ØµÙØ­Ø© Dashboard',
              'Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Dashboard Ø£ÙˆÙ„Ø§Ù‹'
            );
            return;
          }

          // Simulate the exact click behavior
          addLog('ğŸ”— Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ /user/projects/new...');

          // Use window.location to simulate exactly what the button does
          window.location.href = '/user/projects/new';
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: ${error.message}`, 'error');
          addResult('ğŸ–±ï¸ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù†Ù‚Ø±', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      function exportReport() {
        const report = {
          ...diagnosticData,
          timestamp: new Date().toISOString(),
          url: window.location.href,
          userAgent: navigator.userAgent,
        };

        const reportText = JSON.stringify(report, null, 2);
        const blob = new Blob([reportText], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `auth-debug-report-${Date.now()}.json`;
        a.click();

        URL.revokeObjectURL(url);
        addLog('ğŸ“‹ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
      }

      // Auto-run initial checks
      setTimeout(() => {
        checkAuthStatus();
      }, 1000);
    </script>
  </body>
</html>
