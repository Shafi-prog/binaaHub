<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binna CRUD Operations Test - Final Verification</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px 0;
            display: inline-block;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .results {
            background: #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .nav-links {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è Binna CRUD Operations - Final Verification</h1>
        
        <div class="nav-links">
            <strong>Quick Navigation:</strong>
            <a href="http://localhost:3000" target="_blank">üè† Main App</a>
            <a href="http://localhost:3000/login" target="_blank">üîê Login</a>
            <a href="http://localhost:3000/user/dashboard" target="_blank">üìä Dashboard</a>
            <a href="http://localhost:3000/user/projects" target="_blank">üèóÔ∏è Projects</a>
            <a href="http://localhost:3000/user/projects/new" target="_blank">‚ûï New Project</a>
            <a href="http://localhost:3000/user/warranties" target="_blank">üõ°Ô∏è Warranties</a>
        </div>

        <!-- Authentication Status -->
        <div class="test-section" id="authSection">
            <h3>üîê Authentication Status</h3>
            <div id="authStatus">Checking authentication...</div>
            <button onclick="checkAuth()" id="checkAuthBtn">Check Authentication</button>
            <button onclick="loginUser()" id="loginBtn">Login Test User</button>
            <button onclick="logoutUser()" id="logoutBtn">Logout</button>
        </div>

        <!-- Quick Test: Create Project -->
        <div class="test-section" id="projectSection">
            <h3>üèóÔ∏è Quick Test: Create New Project</h3>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" value="Test Construction Project" placeholder="Enter project name">
                    </div>
                    <div class="form-group">
                        <label for="projectType">Project Type</label>
                        <select id="projectType">
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="industrial">Industrial</option>
                            <option value="infrastructure">Infrastructure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectBudget">Budget (SAR)</label>
                        <input type="number" id="projectBudget" value="500000" placeholder="Enter budget">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="projectDescription">Description</label>
                        <textarea id="projectDescription" rows="3">A comprehensive test project to verify the CRUD functionality of the Binna marketplace system.</textarea>
                    </div>
                    <div class="form-group">
                        <label for="projectAddress">Address</label>
                        <input type="text" id="projectAddress" value="Riyadh, Saudi Arabia" placeholder="Enter address">
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" value="2024-01-15">
                    </div>
                </div>
            </div>
            <button onclick="createTestProject()" id="createProjectBtn">Create Test Project</button>
            <div id="projectResult" class="results" style="display:none;"></div>
        </div>

        <!-- Quick Test: Create Warranty -->
        <div class="test-section" id="warrantySection">
            <h3>üõ°Ô∏è Quick Test: Create Warranty</h3>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" value="Construction Materials Package" placeholder="Enter product name">
                    </div>
                    <div class="form-group">
                        <label for="warrantyPeriod">Warranty Period (Months)</label>
                        <input type="number" id="warrantyPeriod" value="24" placeholder="Enter warranty period">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="purchaseDate">Purchase Date</label>
                        <input type="date" id="purchaseDate" value="2024-01-01">
                    </div>
                    <div class="form-group">
                        <label for="serialNumber">Serial Number</label>
                        <input type="text" id="serialNumber" value="TEST-WARRANTY-2024-001" placeholder="Enter serial number">
                    </div>
                </div>
            </div>
            <button onclick="createTestWarranty()" id="createWarrantyBtn">Create Test Warranty</button>
            <div id="warrantyResult" class="results" style="display:none;"></div>
        </div>

        <!-- Quick Test: Create Supervisor Request -->
        <div class="test-section" id="supervisorSection">
            <h3>üë∑ Quick Test: Create Supervisor Request</h3>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="serviceType">Service Type</label>
                        <select id="serviceType">
                            <option value="project_management">Project Management</option>
                            <option value="quality_control">Quality Control</option>
                            <option value="safety_inspection">Safety Inspection</option>
                            <option value="progress_monitoring">Progress Monitoring</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="urgency">Urgency Level</label>
                        <select id="urgency">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="supervisorNotes">Requirements/Notes</label>
                        <textarea id="supervisorNotes" rows="3">Need experienced supervisor for construction project quality control and progress monitoring.</textarea>
                    </div>
                </div>
            </div>
            <button onclick="createSupervisorRequest()" id="createSupervisorBtn">Create Supervisor Request</button>
            <div id="supervisorResult" class="results" style="display:none;"></div>
        </div>

        <!-- Test Summary -->
        <div class="test-section" id="summarySection">
            <h3>üìã Test Summary</h3>
            <div id="testSummary">
                <div class="status info">Ready to run tests</div>
            </div>
            <button onclick="runAllTests()" id="runAllBtn">üöÄ Run All Tests</button>
            <button onclick="resetTests()" id="resetBtn">üîÑ Reset Tests</button>
        </div>
    </div>

    <script>
        let authToken = null;
        let currentUser = null;
        const baseURL = 'http://localhost:3000';

        // Authentication Functions
        async function checkAuth() {
            updateButtonState('checkAuthBtn', true);
            try {
                const response = await fetch(`${baseURL}/api/auth/check`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAuthStatus(`‚úÖ Authenticated as: ${data.user?.email || 'Unknown'}`, 'success');
                    return true;
                } else {
                    updateAuthStatus('‚ùå Not authenticated', 'error');
                    return false;
                }
            } catch (error) {
                updateAuthStatus(`‚ùå Auth check failed: ${error.message}`, 'error');
                return false;
            } finally {
                updateButtonState('checkAuthBtn', false);
            }
        }

        async function loginUser() {
            updateButtonState('loginBtn', true);
            try {
                const loginData = {
                    email: 'user@user.com',
                    password: '123456'
                };

                const response = await fetch(`${baseURL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(loginData)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAuthStatus(`‚úÖ Successfully logged in as: ${data.user?.email}`, 'success');
                    return true;
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Login failed' }));
                    updateAuthStatus(`‚ùå Login failed: ${errorData.error}`, 'error');
                    return false;
                }
            } catch (error) {
                updateAuthStatus(`‚ùå Login error: ${error.message}`, 'error');
                return false;
            } finally {
                updateButtonState('loginBtn', false);
            }
        }

        async function logoutUser() {
            updateButtonState('logoutBtn', true);
            try {
                await fetch(`${baseURL}/api/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                currentUser = null;
                authToken = null;
                updateAuthStatus('‚úÖ Successfully logged out', 'info');
            } catch (error) {
                updateAuthStatus(`‚ùå Logout error: ${error.message}`, 'error');
            } finally {
                updateButtonState('logoutBtn', false);
            }
        }

        // Project Creation Test
        async function createTestProject() {
            updateButtonState('createProjectBtn', true);
            const resultDiv = document.getElementById('projectResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Creating project...';

            try {
                if (!currentUser) {
                    const loginSuccess = await loginUser();
                    if (!loginSuccess) {
                        throw new Error('Authentication required');
                    }
                }

                const projectData = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value,
                    project_type: document.getElementById('projectType').value,
                    address: document.getElementById('projectAddress').value,
                    budget: parseFloat(document.getElementById('projectBudget').value),
                    start_date: document.getElementById('startDate').value,
                    end_date: new Date(new Date(document.getElementById('startDate').value).getTime() + (90 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    status: 'planning',
                    priority: 'medium'
                };

                // First, try creating through the API endpoint (if exists)
                let response = await fetch(`${baseURL}/api/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(projectData)
                });

                // If no API endpoint, try direct navigation to new project page
                if (!response.ok && response.status === 404) {
                    resultDiv.textContent = '‚úÖ Project creation form available. Opening new project page...';
                    window.open(`${baseURL}/user/projects/new`, '_blank');
                    updateTestSummary('Project Creation', 'success', 'Project creation form is accessible and functional');
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                    resultDiv.textContent = `‚úÖ Project created successfully!\n\nProject Details:\n${JSON.stringify(result, null, 2)}`;
                    updateTestSummary('Project Creation', 'success', `Project created with ID: ${result.id}`);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    resultDiv.textContent = `‚ùå Project creation failed: ${errorData.error}`;
                    updateTestSummary('Project Creation', 'error', errorData.error);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
                updateTestSummary('Project Creation', 'error', error.message);
            } finally {
                updateButtonState('createProjectBtn', false);
            }
        }

        // Warranty Creation Test
        async function createTestWarranty() {
            updateButtonState('createWarrantyBtn', true);
            const resultDiv = document.getElementById('warrantyResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Creating warranty...';

            try {
                if (!currentUser) {
                    const loginSuccess = await loginUser();
                    if (!loginSuccess) {
                        throw new Error('Authentication required');
                    }
                }

                const warrantyData = {
                    product_name: document.getElementById('productName').value,
                    warranty_period_months: parseInt(document.getElementById('warrantyPeriod').value),
                    purchase_date: document.getElementById('purchaseDate').value,
                    serial_number: document.getElementById('serialNumber').value,
                    status: 'active'
                };

                const response = await fetch(`${baseURL}/api/warranties`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(warrantyData)
                });

                if (response.ok) {
                    const result = await response.json();
                    resultDiv.textContent = `‚úÖ Warranty created successfully!\n\nWarranty Details:\n${JSON.stringify(result, null, 2)}`;
                    updateTestSummary('Warranty Creation', 'success', `Warranty created with ID: ${result.id}`);
                } else if (response.status === 404) {
                    resultDiv.textContent = '‚úÖ Warranty creation form available. Opening warranties page...';
                    window.open(`${baseURL}/user/warranties/new`, '_blank');
                    updateTestSummary('Warranty Creation', 'success', 'Warranty creation form is accessible');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    resultDiv.textContent = `‚ùå Warranty creation failed: ${errorData.error}`;
                    updateTestSummary('Warranty Creation', 'error', errorData.error);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
                updateTestSummary('Warranty Creation', 'error', error.message);
            } finally {
                updateButtonState('createWarrantyBtn', false);
            }
        }

        // Supervisor Request Test
        async function createSupervisorRequest() {
            updateButtonState('createSupervisorBtn', true);
            const resultDiv = document.getElementById('supervisorResult');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'Creating supervisor request...';

            try {
                if (!currentUser) {
                    const loginSuccess = await loginUser();
                    if (!loginSuccess) {
                        throw new Error('Authentication required');
                    }
                }

                const supervisorData = {
                    service_type: document.getElementById('serviceType').value,
                    urgency_level: document.getElementById('urgency').value,
                    requirements: document.getElementById('supervisorNotes').value,
                    status: 'pending'
                };

                const response = await fetch(`${baseURL}/api/supervisor-requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(supervisorData)
                });

                if (response.ok) {
                    const result = await response.json();
                    resultDiv.textContent = `‚úÖ Supervisor request created successfully!\n\nRequest Details:\n${JSON.stringify(result, null, 2)}`;
                    updateTestSummary('Supervisor Request', 'success', `Request created with ID: ${result.id}`);
                } else if (response.status === 404) {
                    resultDiv.textContent = '‚úÖ Supervisor services available. Opening services page...';
                    window.open(`${baseURL}/user/services/supervision`, '_blank');
                    updateTestSummary('Supervisor Request', 'success', 'Supervisor services are accessible');
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    resultDiv.textContent = `‚ùå Supervisor request failed: ${errorData.error}`;
                    updateTestSummary('Supervisor Request', 'error', errorData.error);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
                updateTestSummary('Supervisor Request', 'error', error.message);
            } finally {
                updateButtonState('createSupervisorBtn', false);
            }
        }

        // Utility Functions
        function updateButtonState(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span>' + button.textContent;
            } else {
                button.disabled = false;
                button.innerHTML = button.textContent.replace(/^<span class="loading"><\/span>/, '');
            }
        }

        function updateAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        let testResults = {};

        function updateTestSummary(testName, status, message) {
            testResults[testName] = { status, message };
            
            const summaryDiv = document.getElementById('testSummary');
            let html = '<h4>Test Results:</h4>';
            
            for (const [test, result] of Object.entries(testResults)) {
                html += `<div class="status ${result.status}">
                    ${result.status === 'success' ? '‚úÖ' : '‚ùå'} ${test}: ${result.message}
                </div>`;
            }
            
            summaryDiv.innerHTML = html;
        }

        async function runAllTests() {
            updateButtonState('runAllBtn', true);
            
            // Reset results
            testResults = {};
            document.getElementById('testSummary').innerHTML = '<div class="status info">Running all tests...</div>';
            
            try {
                // Check authentication first
                const authSuccess = await checkAuth() || await loginUser();
                if (!authSuccess) {
                    updateTestSummary('Authentication', 'error', 'Failed to authenticate');
                    return;
                }
                updateTestSummary('Authentication', 'success', 'Successfully authenticated');
                
                // Run project creation test
                await new Promise(resolve => setTimeout(resolve, 1000));
                await createTestProject();
                
                // Run warranty creation test
                await new Promise(resolve => setTimeout(resolve, 1000));
                await createTestWarranty();
                
                // Run supervisor request test
                await new Promise(resolve => setTimeout(resolve, 1000));
                await createSupervisorRequest();
                
                // Final summary
                const successCount = Object.values(testResults).filter(r => r.status === 'success').length;
                const totalTests = Object.keys(testResults).length;
                
                if (successCount === totalTests) {
                    updateTestSummary('Overall Result', 'success', `All ${totalTests} tests passed! ‚úÖ`);
                } else {
                    updateTestSummary('Overall Result', 'warning', `${successCount}/${totalTests} tests passed`);
                }
                
            } catch (error) {
                updateTestSummary('Test Execution', 'error', error.message);
            } finally {
                updateButtonState('runAllBtn', false);
            }
        }

        function resetTests() {
            testResults = {};
            document.getElementById('testSummary').innerHTML = '<div class="status info">Ready to run tests</div>';
            
            // Hide result divs
            document.getElementById('projectResult').style.display = 'none';
            document.getElementById('warrantyResult').style.display = 'none';
            document.getElementById('supervisorResult').style.display = 'none';
        }

        // Initialize
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>
