(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[347],{3977:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>k});var r=s(5155),a=s(2115),i=s(5695),l=s(3579),n=s(6874),c=s.n(n),o=s(6695),d=s(9503);function u(e){let{status:t,label:s,className:a=""}=e;return(0,r.jsx)("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border ".concat((e=>{switch(e){case"planning":case"medium":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"in_progress":return"bg-blue-100 text-blue-800 border-blue-200";case"completed":case"low":return"bg-green-100 text-green-800 border-green-200";case"cancelled":case"urgent":return"bg-red-100 text-red-800 border-red-200";case"on_hold":default:return"bg-gray-100 text-gray-800 border-gray-200";case"high":return"bg-orange-100 text-orange-800 border-orange-200"}})(t)," ").concat(a),children:s})}function h(e){let{percentage:t,showLabel:s=!0,size:a="md",color:i="blue",className:l=""}=e,n=Math.min(Math.max(t,0),100),c=e=>{switch(e){case"sm":return"h-2";case"lg":return"h-6";default:return"h-4"}};return(0,r.jsxs)("div",{className:"w-full ".concat(l),children:[s&&(0,r.jsxs)("div",{className:"flex justify-between text-sm text-gray-600 mb-1",children:[(0,r.jsx)("span",{children:"التقدم"}),(0,r.jsxs)("span",{children:[n,"%"]})]}),(0,r.jsx)("div",{className:"w-full bg-gray-200 rounded-full overflow-hidden ".concat(c(a)),children:(0,r.jsx)("div",{className:"".concat(c(a)," ").concat((e=>{switch(e){case"green":return"bg-green-500";case"yellow":return"bg-yellow-500";case"red":return"bg-red-500";default:return"bg-blue-500"}})(i)," transition-all duration-300 ease-out"),style:{width:"".concat(n,"%")}})})]})}var x=s(6733),m=s(640);function g(e){return e.toString()}function p(e){return e.toString()}function f(){return(0,r.jsx)("div",{children:"MapPicker Placeholder"})}var b=s(1890);let j=b.env.NEXT_PUBLIC_SUPABASE_URL||"https://placeholder.supabase.co",y=b.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"placeholder-key",N=(()=>{try{return(0,l.createClientComponentClient)({supabaseUrl:j,supabaseKey:y})}catch(e){return{from:()=>({select:()=>({eq:()=>({order:()=>({limit:()=>Promise.resolve({data:[],error:null})})})})}),auth:{getUser:()=>Promise.resolve({data:{user:null},error:null})}}}})();s(2270);class v{static getInstance(){return v.instance||(v.instance=new v),v.instance}subscribeToNotifications(e,t){this.listeners.set(e,t),this.subscription||(this.subscription=N.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:"user_id=eq.".concat(e)},t=>{let s=t.new,r=this.listeners.get(e);r&&(r(s),this.showBrowserNotification(s))}).subscribe())}unsubscribeFromNotifications(e){this.listeners.delete(e),0===this.listeners.size&&this.subscription&&(N.removeChannel(this.subscription),this.subscription=null)}showBrowserNotification(e){"granted"===Notification.permission&&new Notification(e.title,{body:e.message,icon:"/logo.png",tag:e.id})}static async requestNotificationPermission(){return"Notification"in window&&("granted"===Notification.permission||"denied"!==Notification.permission&&"granted"===await Notification.requestPermission())}static async createNotification(e){try{var t,s;if(!e.user_id||!e.title||!e.message)throw console.error("[createNotification] Missing required fields:",{user_id:e.user_id,title:e.title,message:e.message}),Error("Missing required notification fields (user_id, title, message)");let r={user_id:e.user_id,title:e.title,message:e.message,notification_type:e.type,is_read:null!=(t=e.is_read)&&t,link:null!=(s=e.action_url)?s:null};Object.keys(r).forEach(e=>void 0===r[e]?delete r[e]:null),console.log("[createNotification] Payload to insert:",r);let{data:a,error:i}=await N.from("notifications").insert([r]).select().single();if(i)throw console.error("[createNotification] Supabase error:",i,"Payload:",r),i;return a}catch(e){return console.error("Error creating notification:",e),null}}static async markAsRead(e){try{let{error:t}=await N.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e);return!t}catch(e){return console.error("Error marking notification as read:",e),!1}}static async markAllAsRead(e){try{let{error:t}=await N.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);return!t}catch(e){return console.error("Error marking all notifications as read:",e),!1}}static async deleteNotification(e){try{let{error:t}=await N.from("notifications").delete().eq("id",e);return!t}catch(e){return console.error("Error deleting notification:",e),!1}}static async getUnreadCount(e){try{let{count:t,error:s}=await N.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",e).eq("is_read",!1);if(s)throw s;return t||0}catch(e){return console.error("Error getting unread count:",e),0}}constructor(){this.listeners=new Map,this.subscription=null}}let w={PROJECT_UPDATED:"project_updated"};s(8260);let _=(0,a.createContext)(void 0),P={planning:"تأكد من جمع كل التصاريح اللازمة وتحديد الميزانية واختيار المقاول المناسب قبل الانتقال للمرحلة التالية.",design:"راجع التصاميم مع المهندس وتأكد من مطابقتها للاحتياجات، وابدأ في تجهيز مستندات الرخص.",permits:"تأكد من استكمال جميع الأوراق الرسمية والحصول على الرخص اللازمة قبل بدء التنفيذ.",construction:"تابع تقدم العمل مع المقاول، واحتفظ بسجلات المصروفات، وراقب الجودة بشكل دوري.",finishing:"اختر مواد التشطيب بعناية، ونسق مع الموردين لضمان التسليم في الوقت المناسب.",completed:"راجع جميع الأعمال المنجزة، واحتفظ بنسخ من الضمانات والفواتير، واحتفل بإنجاز المشروع!",on_hold:"تابع الإجراءات المطلوبة لإعادة تفعيل المشروع أو حل المشكلات العالقة."};function k(){let e=(0,i.useParams)(),t=(0,i.useRouter)(),s=e.id,[n,b]=(0,a.useState)(null),[j,y]=(0,a.useState)(null),[N,k]=(0,a.useState)(!0),[E,S]=(0,a.useState)(null),[I,D]=(0,a.useState)(null),[U,q]=(0,a.useState)(0),{showNotification:A}=function(){let e=(0,a.useContext)(_);if(!e)throw Error("useNotification must be used within a NotificationProvider");return e}(),[B,L]=(0,a.useState)(null);(0,l.createClientComponentClient)(),(0,a.useEffect)(()=>{(async()=>{try{console.log("\uD83D\uDD0D [Project Detail] Verifying authentication...");let e=await (0,x.s)(3);e?(console.log("✅ [Project Detail] User authenticated:",e.email),b(e.user),S(null)):(console.error("❌ [Project Detail] Authentication failed"),S("يرجى تسجيل الدخول للمتابعة"),t.push("/login"))}catch(e){console.error("❌ [Project Detail] Auth error:",e),S("خطأ في المصادقة"),t.push("/login")}finally{k(!1)}})()},[t]),(0,a.useEffect)(()=>{n&&s&&(console.log("[DEBUG] user.id:",n.id,"projectId:",s),M())},[n,s]);let M=async()=>{if(!n){console.error("❌ [fetchProject] No user available"),D("المستخدم غير مصادق عليه");return}k(!0),D(null),y(null);try{console.log("\uD83D\uDD0D Fetching project:",s,"for user:",null==n?void 0:n.id);let e=(0,l.createClientComponentClient)(),{data:{user:r},error:a}=await e.auth.getUser();if(console.log("\uD83D\uDD0D [fetchProject] Fresh auth check:",{currentUser:r?{id:r.id,email:r.email}:null,authError:null==a?void 0:a.message,originalUser:{id:n.id,email:n.email},userMatch:(null==r?void 0:r.id)===n.id}),a||!r){console.error("❌ [fetchProject] Authentication failed in fresh check:",a),D("خطأ في المصادقة - يرجى تسجيل الدخول مرة أخرى"),t.push("/login");return}let i=await (0,m.G6)(s);if(console.log("\uD83D\uDCE6 getProjectById result:",i),i){let e={id:i.id,title:i.name,description:i.description,status:i.status,priority:i.priority,budget:i.budget,actual_cost:i.actual_cost,start_date:i.start_date,end_date:i.actual_completion_date,deadline:i.expected_completion_date,category:i.project_type,progress_percentage:i.progress_percentage,created_at:i.created_at,updated_at:i.updated_at,location:i.location};y(e),D(null),console.log("✅ Project loaded:",e)}else{console.log("\uD83D\uDD0D [fetchProject] getProjectById returned null, trying direct query...");let{data:t,error:a}=await e.from("projects").select("id, name, user_id, status, created_at").eq("id",s);if(console.log("\uD83D\uDCCA [fetchProject] Direct query result:",{directProject:t,directError:null==a?void 0:a.message,count:null==t?void 0:t.length}),t&&t.length>0){let e=t[0];console.log("\uD83D\uDCCB [fetchProject] Project exists but not accessible:",{projectId:e.id,projectUserId:e.user_id,currentUserId:r.id,match:e.user_id===r.id}),e.user_id!==r.id?D("ليس لديك صلاحية للوصول إلى هذا المشروع"):D("خطأ غير متوقع في تحميل المشروع")}else D("المشروع غير موجود (projectId: ".concat(s,", userId: ").concat(null==n?void 0:n.id,")"));y(null),console.log("❌ Project not found",{projectId:s,userId:null==n?void 0:n.id})}}catch(e){console.error("Error fetching project:",e,{projectId:s,userId:null==n?void 0:n.id}),D("حدث خطأ في تحميل بيانات المشروع"),y(null)}finally{k(!1)}},O=async()=>{if(U>=3)return void console.log("❌ Max retry attempts reached");console.log("\uD83D\uDD04 Retrying project fetch (attempt ".concat(U+1,"/3)...")),q(e=>e+1),await M()};return((0,a.useEffect)(()=>{if(j&&j.status&&B!==j.status){let e=P[j.status];e&&(A({type:"info",message:"نصيحة للمرحلة الحالية: ".concat(e)}),v.createNotification({user_id:(null==n?void 0:n.id)||"",type:w.PROJECT_UPDATED,title:"تقدم المشروع",message:"تم الانتقال إلى مرحلة: ".concat(j.status),data:{projectId:j.id,status:j.status},is_read:!1,priority:"normal",channel:"app",sent_at:new Date().toISOString()})),L(j.status)}},[null==j?void 0:j.status]),N)?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsx)(d.k,{})}):E||I?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)(o.Z,{className:"p-6 text-center",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-red-600 mb-4",children:"خطأ"}),(0,r.jsx)("p",{className:"text-gray-600",children:E||I}),U<3&&(0,r.jsx)("button",{onClick:O,disabled:N,className:"mt-4 bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white px-4 py-2 rounded-lg transition-colors",children:N?"جاري إعادة المحاولة...":"إعادة المحاولة (".concat(U,"/3)")}),U>=3&&(0,r.jsx)("div",{className:"mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg",children:(0,r.jsx)("p",{className:"text-sm text-yellow-800",children:"تم استنفاد محاولات إعادة التحميل. يرجى التحقق من الاتصال بالإنترنت أو المحاولة لاحقاً."})}),(0,r.jsx)("button",{onClick:()=>t.back(),className:"mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors",children:"العودة"})]})}):j?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,r.jsxs)("div",{className:"container mx-auto px-4 max-w-6xl",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsx)("button",{onClick:()=>t.back(),className:"p-2 hover:bg-gray-200 rounded-lg transition-colors",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:j.title}),(0,r.jsx)("p",{className:"text-gray-600",children:"تفاصيل المشروع وحالة التقدم"})]})]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,r.jsx)(u,{status:j.status,label:j.status}),(0,r.jsx)(u,{status:j.priority,label:"أولوية ".concat("low"===j.priority?"منخفضة":"medium"===j.priority?"متوسطة":"high"===j.priority?"عالية":"عاجلة")})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,r.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,r.jsxs)(o.Z,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"تفاصيل المشروع"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-2",children:"الوصف"}),(0,r.jsx)("p",{className:"text-gray-600",children:j.description})]}),j.category&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-2",children:"الفئة"}),(0,r.jsx)("p",{className:"text-gray-600",children:j.category})]})]})]}),(0,r.jsxs)(o.Z,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"تقدم المشروع"}),(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"النسبة المكتملة"}),(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:[j.progress_percentage||0,"%"]})]})," ",(0,r.jsx)(h,{percentage:j.progress_percentage||0,showLabel:!1})]})})]}),(0,r.jsxs)(o.Z,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"الإجراءات"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,r.jsxs)(c(),{href:"/user/projects/".concat(j.id,"/edit"),className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"تعديل المشروع"]}),(0,r.jsxs)("button",{className:"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"تقرير التقدم"]})]})]})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)(o.Z,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"معلومات المشروع"}),(0,r.jsxs)("div",{className:"space-y-4",children:[j.budget&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"الميزانية المقدرة"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-green-600",children:g(j.budget)})]}),j.actual_cost&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"التكلفة الفعلية"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-blue-600",children:g(j.actual_cost)})]}),j.start_date&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"تاريخ البداية"}),(0,r.jsx)("p",{className:"text-gray-600",children:p(j.start_date)})]}),j.deadline&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"الموعد النهائي"}),(0,r.jsx)("p",{className:"text-gray-600",children:p(j.deadline)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"تاريخ الإنشاء"}),(0,r.jsx)("p",{className:"text-gray-600",children:p(j.created_at)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"آخر تحديث"}),(0,r.jsx)("p",{className:"text-gray-600",children:p(j.updated_at)})]}),j.location&&(()=>{let e=null;try{let t="string"==typeof j.location?JSON.parse(j.location):j.location;t&&"number"==typeof t.lat&&"number"==typeof t.lng&&(e={lat:t.lat,lng:t.lng})}catch(e){}return e?(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"موقع المشروع على الخريطة"}),(0,r.jsx)("div",{className:"h-40 w-full border rounded-lg overflow-hidden mb-2",children:(0,r.jsx)(f,{initialLocation:e,readOnly:!0})}),(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["خط العرض: ",e.lat,", خط الطول: ",e.lng]})]}):null})()]})]}),(0,r.jsxs)(o.Z,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"مراحل البناء"}),(0,r.jsx)(C,{status:j.status}),P[j.status]&&(0,r.jsxs)("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg text-blue-800 text-sm",children:[(0,r.jsx)("span",{className:"font-bold",children:"نصيحة:"})," ",P[j.status]]})]})]})]})]})}):(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)(o.Z,{className:"p-6 text-center",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"المشروع غير موجود"}),(0,r.jsx)("p",{className:"text-gray-600",children:"لم يتم العثور على المشروع المطلوب"}),(0,r.jsx)(c(),{href:"/user/projects",className:"inline-block mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors",children:"العودة للمشاريع"})]})})}let E=[{value:"planning",label:"تخطيط"},{value:"design",label:"تصميم"},{value:"permits",label:"رخص"},{value:"construction",label:"تنفيذ"},{value:"finishing",label:"تشطيب"},{value:"completed",label:"مكتمل"}];function C(e){let{status:t}=e,s=E.findIndex(e=>e.value===t);return(0,r.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,r.jsx)("div",{className:"flex items-center gap-2",children:E.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ".concat(t<=s?"bg-blue-600":"bg-gray-300"),children:t+1}),t<E.length-1&&(0,r.jsx)("div",{className:"h-1 w-8 ".concat(t<s?"bg-blue-600":"bg-gray-200")})]},e.value))}),(0,r.jsx)("div",{className:"flex justify-between text-xs text-gray-700 mt-1",children:E.map(e=>(0,r.jsx)("span",{className:"w-8 text-center",children:e.label},e.value))})]})}},5619:(e,t,s)=>{Promise.resolve().then(s.bind(s,3977))}},e=>{var t=t=>e(e.s=t);e.O(0,[77,834,180,441,684,358],()=>t(5619)),_N_E=e.O()}]);