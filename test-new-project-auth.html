<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>اختبار مصادقة صفحة المشروع الجديد</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      .info {
        background: #cce7ff;
        border-color: #b3d9ff;
        color: #004085;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      #log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔍 اختبار مصادقة صفحة المشروع الجديد</h1>

      <div class="status info">
        <strong>هدف الاختبار:</strong> التحقق من سبب إعادة توجيه صفحة "/user/projects/new" إلى صفحة
        تسجيل الدخول
      </div>

      <div id="authStatus" class="status warning">⏳ جاري فحص حالة المصادقة...</div>

      <div style="margin: 20px 0">
        <button onclick="checkAuth()" class="btn-primary">🔍 فحص المصادقة الحالية</button>
        <button onclick="testLoginFlow()" class="btn-success">🔐 اختبار تدفق تسجيل الدخول</button>
        <button onclick="testNewProjectAccess()" class="btn-warning">
          🆕 اختبار الوصول لصفحة المشروع الجديد
        </button>
        <button onclick="diagnoseMiddleware()" class="btn-danger">🔧 تشخيص Middleware</button>
        <button
          onclick="clearLog()"
          class="btn-secondary"
          style="background: #6c757d; color: white"
        >
          🗑️ مسح السجل
        </button>
      </div>

      <div id="testResults"></div>

      <h3>🔍 سجل التشخيص المفصل:</h3>
      <div id="log"></div>
    </div>

    <script>
      const log = document.getElementById('log');
      const authStatus = document.getElementById('authStatus');
      const testResults = document.getElementById('testResults');

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleString('ar-SA');
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        log.textContent += logEntry;
        log.scrollTop = log.scrollHeight;
        console.log(logEntry);
      }

      function clearLog() {
        log.textContent = '';
        testResults.innerHTML = '';
      }

      function updateStatus(message, type) {
        authStatus.className = `status ${type}`;
        authStatus.innerHTML = message;
      }

      function addResult(title, status, details) {
        const result = document.createElement('div');
        result.className = `status ${status}`;
        result.innerHTML = `<strong>${title}:</strong> ${details}`;
        testResults.appendChild(result);
      }

      async function checkAuth() {
        addLog('🔍 بدء فحص حالة المصادقة...');

        try {
          // Check cookies
          const cookies = document.cookie;
          addLog(`🍪 Cookies المتاحة: ${cookies.length > 0 ? 'موجودة' : 'غير موجودة'}`);

          // Check for Supabase auth cookies
          const authCookies = cookies
            .split(';')
            .filter((c) => c.includes('sb-') || c.includes('supabase') || c.includes('auth'));
          addLog(`🔑 Auth cookies: ${authCookies.length} موجودة`);
          authCookies.forEach((cookie) => {
            const [name] = cookie.trim().split('=');
            addLog(`   - ${name}`);
          });

          // Try to fetch auth status from diagnostic endpoint
          const response = await fetch('/auth-diagnostic');
          const text = await response.text();

          if (response.ok) {
            addLog('✅ نجح الوصول لصفحة التشخيص');

            // Check if we're authenticated by looking for specific text
            if (text.includes('User authenticated') || text.includes('✅')) {
              updateStatus('✅ المستخدم مصادق بنجاح', 'success');
              addResult('🔐 حالة المصادقة', 'success', 'مصادق ومسجل دخول');
            } else if (text.includes('Not authenticated') || text.includes('❌')) {
              updateStatus('❌ المستخدم غير مصادق', 'error');
              addResult('🔐 حالة المصادقة', 'error', 'غير مصادق أو انتهت الجلسة');
            } else {
              updateStatus('⚠️ حالة مصادقة غير واضحة', 'warning');
              addResult('🔐 حالة المصادقة', 'warning', 'لا يمكن تحديد الحالة بوضوح');
            }
          } else {
            addLog(`❌ فشل الوصول لصفحة التشخيص: ${response.status}`);
            updateStatus('❌ خطأ في فحص المصادقة', 'error');
          }
        } catch (error) {
          addLog(`❌ خطأ في فحص المصادقة: ${error.message}`);
          updateStatus('❌ خطأ في فحص المصادقة', 'error');
          addResult('🔐 حالة المصادقة', 'error', `خطأ: ${error.message}`);
        }
      }

      async function testLoginFlow() {
        addLog('🔐 اختبار تدفق تسجيل الدخول...');

        const email = 'test@example.com'; // Replace with actual test email
        const password = 'test123456'; // Replace with actual test password

        try {
          const response = await fetch('/login', {
            method: 'GET',
          });

          if (response.ok) {
            addLog('✅ صفحة تسجيل الدخول متاحة');
            addResult('📝 صفحة تسجيل الدخول', 'success', 'متاحة ويمكن الوصول إليها');
          } else {
            addLog(`❌ مشكلة في صفحة تسجيل الدخول: ${response.status}`);
            addResult('📝 صفحة تسجيل الدخول', 'error', `خطأ HTTP ${response.status}`);
          }
        } catch (error) {
          addLog(`❌ خطأ في اختبار صفحة تسجيل الدخول: ${error.message}`);
          addResult('📝 صفحة تسجيل الدخول', 'error', `خطأ: ${error.message}`);
        }
      }

      async function testNewProjectAccess() {
        addLog('🆕 اختبار الوصول لصفحة المشروع الجديد...');

        try {
          const response = await fetch('/user/projects/new', {
            method: 'GET',
            redirect: 'manual', // Don't follow redirects automatically
          });

          addLog(`📡 استجابة الخادم: ${response.status} ${response.statusText}`);

          if (response.status === 200) {
            addLog('✅ نجح الوصول لصفحة المشروع الجديد');
            addResult('🆕 صفحة المشروع الجديد', 'success', 'متاحة ويمكن الوصول إليها');
          } else if (response.status === 307 || response.status === 302) {
            const location = response.headers.get('location');
            addLog(`🔄 إعادة توجيه إلى: ${location}`);

            if (location === '/login') {
              addResult(
                '🆕 صفحة المشروع الجديد',
                'error',
                'يتم إعادة التوجيه إلى صفحة تسجيل الدخول - مشكلة في المصادقة'
              );
            } else {
              addResult('🆕 صفحة المشروع الجديد', 'warning', `إعادة توجيه إلى: ${location}`);
            }
          } else {
            addLog(`❌ خطأ في الوصول: ${response.status}`);
            addResult('🆕 صفحة المشروع الجديد', 'error', `خطأ HTTP ${response.status}`);
          }

          // Test headers
          const headers = {};
          response.headers.forEach((value, key) => {
            headers[key] = value;
          });
          addLog(`📋 Headers: ${JSON.stringify(headers, null, 2)}`);
        } catch (error) {
          addLog(`❌ خطأ في اختبار الوصول: ${error.message}`);
          addResult('🆕 صفحة المشروع الجديد', 'error', `خطأ: ${error.message}`);
        }
      }

      async function diagnoseMiddleware() {
        addLog('🔧 تشخيص Middleware...');

        try {
          // Test various protected routes to see middleware behavior
          const testRoutes = [
            '/user/dashboard',
            '/user/projects',
            '/user/projects/new',
            '/user/profile',
          ];

          for (const route of testRoutes) {
            addLog(`🧪 اختبار المسار: ${route}`);

            const response = await fetch(route, {
              method: 'GET',
              redirect: 'manual',
            });

            const status = response.status;
            const location = response.headers.get('location');

            if (status === 200) {
              addLog(`✅ ${route}: وصول ناجح`);
              addResult(`🛡️ ${route}`, 'success', 'مسموح الوصول');
            } else if (status === 307 || status === 302) {
              addLog(`🔄 ${route}: إعادة توجيه إلى ${location}`);
              if (location === '/login') {
                addResult(`🛡️ ${route}`, 'error', 'مرفوض - إعادة توجيه لتسجيل الدخول');
              } else {
                addResult(`🛡️ ${route}`, 'warning', `إعادة توجيه إلى ${location}`);
              }
            } else {
              addLog(`❌ ${route}: خطأ ${status}`);
              addResult(`🛡️ ${route}`, 'error', `خطأ HTTP ${status}`);
            }
          }
        } catch (error) {
          addLog(`❌ خطأ في تشخيص Middleware: ${error.message}`);
          addResult('🔧 تشخيص Middleware', 'error', `خطأ: ${error.message}`);
        }
      }

      // Run initial check
      checkAuth();
    </script>
  </body>
</html>
