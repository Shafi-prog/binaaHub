<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ø®ØªØ¨Ø§Ø± ØªØ¯ÙÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        direction: rtl;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        background: #f8f9fa;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px 5px;
        font-size: 14px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn.success {
        background: #28a745;
      }
      .btn.danger {
        background: #dc3545;
      }
      .btn.warning {
        background: #ffc107;
        color: #000;
      }
      .result {
        background: #e9ecef;
        padding: 15px;
        margin: 10px 0;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #007bff;
      }
      .warning {
        color: #ffc107;
      }
      .status {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        display: none;
      }
      .status.show {
        display: block;
      }
      .status.success {
        background: #28a745;
      }
      .status.error {
        background: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="status" id="status"></div>

    <div class="container">
      <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØªØ¯ÙÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø«</h1>

      <div class="test-section">
        <h3>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</h3>
        <p>Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©)</p>
        <button class="btn" onclick="testUserLogin()">ğŸ§‘ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn" onclick="testStoreLogin()">ğŸª Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button class="btn warning" onclick="clearResults()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        <div class="result" id="authResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡</h3>
        <p>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
        <button class="btn" onclick="testUserRedirect()">ğŸ§‘ Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn" onclick="testStoreRedirect()">ğŸª Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button class="btn success" onclick="testDirectAccess()">ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
        <div class="result" id="redirectResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
        <p>Ø£Ø¯ÙˆØ§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</p>
        <button class="btn" onclick="checkCurrentAuth()">ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button class="btn" onclick="testRefreshEndpoint()">ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn" onclick="testMiddleware()">ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù€ Middleware</button>
        <button class="btn danger" onclick="clearAuth()">ğŸšª Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</button>
        <div class="result" id="diagnosticResult"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ø´Ø§Ù…Ù„</h3>
        <p>Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
        <button class="btn success" onclick="runFullTest()">ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</button>
        <div class="result" id="fullTestResult"></div>
      </div>
    </div>

    <script type="module">
      // Import Supabase client
      import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2.39.3';

      const supabaseUrl = 'https://lvnhakmdswjdozwkkmnl.supabase.co';
      const supabaseKey =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2bmhha21kc3dqZG96d2trbW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3OTI0NzgsImV4cCI6MjA1MjM2ODQ3OH0.nrQR69a4P1zlr5P3wE5qKyKDCXFTgDTRN7R4Lf04xCo';

      window.supabase = createClient(supabaseUrl, supabaseKey);

      // Make functions available globally
      window.testUserLogin = testUserLogin;
      window.testStoreLogin = testStoreLogin;
      window.testUserRedirect = testUserRedirect;
      window.testStoreRedirect = testStoreRedirect;
      window.testDirectAccess = testDirectAccess;
      window.checkCurrentAuth = checkCurrentAuth;
      window.testRefreshEndpoint = testRefreshEndpoint;
      window.testMiddleware = testMiddleware;
      window.clearAuth = clearAuth;
      window.clearResults = clearResults;
      window.runFullTest = runFullTest;

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ar-EG');
        const color =
          {
            success: 'success',
            error: 'error',
            info: 'info',
            warning: 'warning',
          }[type] || 'info';

        return `<div class="${color}">[${timestamp}] ${message}</div>`;
      }

      function showStatus(message, type = 'success') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status show ${type}`;
        setTimeout(() => {
          status.classList.remove('show');
        }, 3000);
      }

      function appendToResult(resultId, content) {
        const result = document.getElementById(resultId);
        result.innerHTML += content;
        result.scrollTop = result.scrollHeight;
      }

      async function testUserLogin() {
        const resultId = 'authResult';
        appendToResult(resultId, log('ğŸ” Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...', 'info'));

        try {
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'user@user.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error'));
            showStatus('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
            return;
          }

          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success'));
          appendToResult(resultId, log(`ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${data.user?.email}`, 'info'));
          appendToResult(
            resultId,
            log(`ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©: ${data.session?.access_token?.substring(0, 20)}...`, 'info')
          );

          // Test getting user data
          const { data: userData, error: userError } = await window.supabase
            .from('users')
            .select('account_type')
            .eq('email', 'user@user.com')
            .single();

          if (userError) {
            appendToResult(
              resultId,
              log(`âš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userError.message}`, 'warning')
            );
          } else {
            appendToResult(resultId, log(`âœ… Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨: ${userData.account_type}`, 'success'));
          }

          showStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: ${error.message}`, 'error'));
          showStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
        }
      }

      async function testStoreLogin() {
        const resultId = 'authResult';
        appendToResult(resultId, log('ğŸª Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±...', 'info'));

        try {
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'store@store.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error'));
            showStatus('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±', 'error');
            return;
          }

          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success'));
          appendToResult(resultId, log(`ğŸª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${data.user?.email}`, 'info'));
          appendToResult(
            resultId,
            log(`ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©: ${data.session?.access_token?.substring(0, 20)}...`, 'info')
          );

          // Test getting store data
          const { data: storeData, error: storeError } = await window.supabase
            .from('users')
            .select('account_type')
            .eq('email', 'store@store.com')
            .single();

          if (storeError) {
            appendToResult(
              resultId,
              log(`âš ï¸ ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±: ${storeError.message}`, 'warning')
            );
          } else {
            appendToResult(resultId, log(`âœ… Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨: ${storeData.account_type}`, 'success'));
          }

          showStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: ${error.message}`, 'error'));
          showStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±', 'error');
        }
      }

      async function testUserRedirect() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...', 'info'));

        try {
          // First login
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'user@user.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, 'error'));
            return;
          }

          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...', 'success'));

          // Simulate the redirect
          await new Promise((resolve) => setTimeout(resolve, 1000));
          window.open('http://localhost:3004/user/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('ğŸš€ ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'info'));
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡: ${error.message}`, 'error'));
        }
      }

      async function testStoreRedirect() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…ØªØ¬Ø±...', 'info'));

        try {
          // First login
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'store@store.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, 'error'));
            return;
          }

          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...', 'success'));

          // Simulate the redirect
          await new Promise((resolve) => setTimeout(resolve, 1000));
          window.open('http://localhost:3004/store/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('ğŸš€ ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø± ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©', 'info'));
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡: ${error.message}`, 'error'));
        }
      }

      async function testDirectAccess() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©...', 'info'));

        const pages = [
          { name: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', url: 'http://localhost:3004/user/dashboard' },
          { name: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', url: 'http://localhost:3004/user/profile' },
          { name: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹', url: 'http://localhost:3004/user/projects' },
          { name: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø±', url: 'http://localhost:3004/store/dashboard' },
        ];

        for (const page of pages) {
          appendToResult(resultId, log(`ğŸ”— ÙØªØ­ ${page.name}...`, 'info'));
          window.open(page.url, '_blank');
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        appendToResult(resultId, log('âœ… ØªÙ… ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success'));
      }

      async function checkCurrentAuth() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...', 'info'));

        try {
          const {
            data: { session },
            error,
          } = await window.supabase.auth.getSession();

          if (error) {
            appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©: ${error.message}`, 'error'));
            return;
          }

          if (session && session.user) {
            appendToResult(resultId, log('âœ… ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©', 'success'));
            appendToResult(resultId, log(`ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${session.user.email}`, 'info'));
            appendToResult(
              resultId,
              log(
                `ğŸ•’ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©: ${new Date(session.expires_at * 1000).toLocaleString('ar-EG')}`,
                'info'
              )
            );

            // Check cookies
            const cookies = document.cookie.split(';').filter((c) => c.includes('sb-'));
            appendToResult(resultId, log(`ğŸª Ø¹Ø¯Ø¯ ÙƒÙˆÙƒÙŠØ² Supabase: ${cookies.length}`, 'info'));
          } else {
            appendToResult(resultId, log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©', 'error'));
          }
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error'));
        }
      }

      async function testRefreshEndpoint() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...', 'info'));

        try {
          const response = await fetch('http://localhost:3004/api/auth/refresh', {
            method: 'GET',
            credentials: 'include',
          });

          const data = await response.json();

          if (response.ok) {
            appendToResult(resultId, log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success'));
            appendToResult(resultId, log(`ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${JSON.stringify(data, null, 2)}`, 'info'));
          } else {
            appendToResult(resultId, log(`âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${data.error}`, 'error'));
          }
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${error.message}`, 'error'));
        }
      }

      async function testMiddleware() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('ğŸ›¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù€ Middleware...', 'info'));

        const testUrls = [
          'http://localhost:3004/auth-diagnostic',
          'http://localhost:3004/auth-check',
        ];

        for (const url of testUrls) {
          try {
            appendToResult(resultId, log(`ğŸ”— Ø§Ø®ØªØ¨Ø§Ø±: ${url}`, 'info'));
            window.open(url, '_blank');
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ ${url}: ${error.message}`, 'error'));
          }
        }

        appendToResult(resultId, log('âœ… ØªÙ… ÙØªØ­ ØµÙØ­Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ', 'success'));
      }

      async function clearAuth() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('ğŸšª Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...', 'info'));

        try {
          await window.supabase.auth.signOut();
          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success'));

          // Clear cookies
          document.cookie.split(';').forEach(function (c) {
            document.cookie = c
              .replace(/^ +/, '')
              .replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
          });

          appendToResult(resultId, log('ğŸª ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆÙƒÙŠØ²', 'info'));
          showStatus('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'success');
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`, 'error'));
          showStatus('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error');
        }
      }

      function clearResults() {
        document.querySelectorAll('.result').forEach((result) => {
          result.innerHTML = '';
        });
        showStatus('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 'success');
      }

      async function runFullTest() {
        const resultId = 'fullTestResult';
        appendToResult(resultId, log('ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...', 'info'));

        try {
          // Step 1: Clear any existing auth
          await window.supabase.auth.signOut();
          appendToResult(resultId, log('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'info'));

          // Step 2: Test user login
          appendToResult(resultId, log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...', 'info'));
          const { data: userData, error: userError } =
            await window.supabase.auth.signInWithPassword({
              email: 'user@user.com',
              password: '123456',
            });

          if (userError) {
            appendToResult(
              resultId,
              log(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userError.message}`, 'error')
            );
            return;
          }

          appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success'));

          // Step 3: Test refresh endpoint
          appendToResult(resultId, log('ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«...', 'info'));
          try {
            const refreshResponse = await fetch('http://localhost:3004/api/auth/refresh', {
              method: 'GET',
              credentials: 'include',
            });

            if (refreshResponse.ok) {
              const refreshData = await refreshResponse.json();
              appendToResult(
                resultId,
                log(
                  `âœ… Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªØ¹Ù…Ù„: ${refreshData.authenticated ? 'Ù…ØµØ§Ø¯Ù‚' : 'ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚'}`,
                  'success'
                )
              );
            } else {
              appendToResult(resultId, log('âš ï¸ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§ ØªØ¹Ù…Ù„ ÙƒÙ…Ø§ Ù…ØªÙˆÙ‚Ø¹', 'warning'));
            }
          } catch (refreshError) {
            appendToResult(
              resultId,
              log(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«: ${refreshError.message}`, 'warning')
            );
          }

          // Step 4: Test redirect simulation
          appendToResult(resultId, log('ğŸš€ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', 'info'));
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Open dashboard with post_login parameter
          window.open('http://localhost:3004/user/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('âœ… ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø¹ Ù…Ø¹Ø§Ù…Ù„ post_login', 'success'));

          // Step 5: Test store login
          appendToResult(resultId, log('ğŸª Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±...', 'info'));
          const { data: storeData, error: storeError } =
            await window.supabase.auth.signInWithPassword({
              email: 'store@store.com',
              password: '123456',
            });

          if (storeError) {
            appendToResult(
              resultId,
              log(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±: ${storeError.message}`, 'error')
            );
          } else {
            appendToResult(resultId, log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success'));

            // Open store dashboard
            await new Promise((resolve) => setTimeout(resolve, 1000));
            window.open('http://localhost:3004/store/dashboard?post_login=true', '_blank');
            appendToResult(resultId, log('âœ… ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ¬Ø±', 'success'));
          }

          appendToResult(resultId, log('ğŸ‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success'));
          showStatus('ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } catch (error) {
          appendToResult(resultId, log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„: ${error.message}`, 'error'));
          showStatus('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„', 'error');
        }
      }

      // Initial status check
      window.addEventListener('load', () => {
        showStatus('Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'success');
      });
    </script>
  </body>
</html>
