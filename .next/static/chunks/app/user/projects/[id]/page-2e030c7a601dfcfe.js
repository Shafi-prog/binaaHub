(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[347],{285:(e,t,s)=>{"use strict";s(5155),s(2115)},671:(e,t,s)=>{"use strict";s.d(t,{Card:()=>r.Z,LoadingSpinner:()=>a.k});var r=s(6695),a=s(9503);s(285),s(2523);var i=s(1521);s.o(i,"ProgressBar")&&s.d(t,{ProgressBar:function(){return i.ProgressBar}}),s.o(i,"StatusBadge")&&s.d(t,{StatusBadge:function(){return i.StatusBadge}});var n=s(5848);s.o(n,"ProgressBar")&&s.d(t,{ProgressBar:function(){return n.ProgressBar}}),s.o(n,"StatusBadge")&&s.d(t,{StatusBadge:function(){return n.StatusBadge}})},714:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>y});var r=s(5155),a=s(2115),i=s(5695),n=s(3579),l=s(6874),o=s.n(l),c=s(671),d=s(6733),u=s(640);function h(e){return e.toString()}function x(e){return e.toString()}function m(){return(0,r.jsx)("div",{children:"MapPicker Placeholder"})}let g={};s(2270);class p{static getInstance(){return p.instance||(p.instance=new p),p.instance}subscribeToNotifications(e,t){this.listeners.set(e,t),this.subscription||(this.subscription=g.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:"user_id=eq.".concat(e)},t=>{let s=t.new,r=this.listeners.get(e);r&&(r(s),this.showBrowserNotification(s))}).subscribe())}unsubscribeFromNotifications(e){this.listeners.delete(e),0===this.listeners.size&&this.subscription&&(g.removeChannel(this.subscription),this.subscription=null)}showBrowserNotification(e){"granted"===Notification.permission&&new Notification(e.title,{body:e.message,icon:"/logo.png",tag:e.id})}static async requestNotificationPermission(){return"Notification"in window&&("granted"===Notification.permission||"denied"!==Notification.permission&&"granted"===await Notification.requestPermission())}static async createNotification(e){try{var t,s;if(!e.user_id||!e.title||!e.message)throw console.error("[createNotification] Missing required fields:",{user_id:e.user_id,title:e.title,message:e.message}),Error("Missing required notification fields (user_id, title, message)");let r={user_id:e.user_id,title:e.title,message:e.message,notification_type:e.type,is_read:null!=(t=e.is_read)&&t,link:null!=(s=e.action_url)?s:null};Object.keys(r).forEach(e=>void 0===r[e]?delete r[e]:null),console.log("[createNotification] Payload to insert:",r);let{data:a,error:i}=await g.from("notifications").insert([r]).select().single();if(i)throw console.error("[createNotification] Supabase error:",i,"Payload:",r),i;return a}catch(e){return console.error("Error creating notification:",e),null}}static async markAsRead(e){try{let{error:t}=await g.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e);return!t}catch(e){return console.error("Error marking notification as read:",e),!1}}static async markAllAsRead(e){try{let{error:t}=await g.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",e).eq("is_read",!1);return!t}catch(e){return console.error("Error marking all notifications as read:",e),!1}}static async deleteNotification(e){try{let{error:t}=await g.from("notifications").delete().eq("id",e);return!t}catch(e){return console.error("Error deleting notification:",e),!1}}static async getUnreadCount(e){try{let{count:t,error:s}=await g.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",e).eq("is_read",!1);if(s)throw s;return t||0}catch(e){return console.error("Error getting unread count:",e),0}}constructor(){this.listeners=new Map,this.subscription=null}}let f={PROJECT_UPDATED:"project_updated"};s(8260);let j=(0,a.createContext)(void 0),b={planning:"تأكد من جمع كل التصاريح اللازمة وتحديد الميزانية واختيار المقاول المناسب قبل الانتقال للمرحلة التالية.",design:"راجع التصاميم مع المهندس وتأكد من مطابقتها للاحتياجات، وابدأ في تجهيز مستندات الرخص.",permits:"تأكد من استكمال جميع الأوراق الرسمية والحصول على الرخص اللازمة قبل بدء التنفيذ.",construction:"تابع تقدم العمل مع المقاول، واحتفظ بسجلات المصروفات، وراقب الجودة بشكل دوري.",finishing:"اختر مواد التشطيب بعناية، ونسق مع الموردين لضمان التسليم في الوقت المناسب.",completed:"راجع جميع الأعمال المنجزة، واحتفظ بنسخ من الضمانات والفواتير، واحتفل بإنجاز المشروع!",on_hold:"تابع الإجراءات المطلوبة لإعادة تفعيل المشروع أو حل المشكلات العالقة."};function y(){let e=(0,i.useParams)(),t=(0,i.useRouter)(),s=e.id,[l,g]=(0,a.useState)(null),[y,N]=(0,a.useState)(null),[_,w]=(0,a.useState)(!0),[P,k]=(0,a.useState)(null),[C,S]=(0,a.useState)(null),[B,E]=(0,a.useState)(0),{showNotification:D}=function(){let e=(0,a.useContext)(j);if(!e)throw Error("useNotification must be used within a NotificationProvider");return e}(),[I,q]=(0,a.useState)(null);(0,n.createClientComponentClient)(),(0,a.useEffect)(()=>{(async()=>{try{console.log("\uD83D\uDD0D [Project Detail] Verifying authentication...");let e=await (0,d.s)(3);e?(console.log("✅ [Project Detail] User authenticated:",e.email),g(e.user),k(null)):(console.error("❌ [Project Detail] Authentication failed"),k("يرجى تسجيل الدخول للمتابعة"),t.push("/login"))}catch(e){console.error("❌ [Project Detail] Auth error:",e),k("خطأ في المصادقة"),t.push("/login")}finally{w(!1)}})()},[t]),(0,a.useEffect)(()=>{l&&s&&(console.log("[DEBUG] user.id:",l.id,"projectId:",s),L())},[l,s]);let L=async()=>{if(!l){console.error("❌ [fetchProject] No user available"),S("المستخدم غير مصادق عليه");return}w(!0),S(null),N(null);try{console.log("\uD83D\uDD0D Fetching project:",s,"for user:",null==l?void 0:l.id);let e=(0,n.createClientComponentClient)(),{data:{user:r},error:a}=await e.auth.getUser();if(console.log("\uD83D\uDD0D [fetchProject] Fresh auth check:",{currentUser:r?{id:r.id,email:r.email}:null,authError:null==a?void 0:a.message,originalUser:{id:l.id,email:l.email},userMatch:(null==r?void 0:r.id)===l.id}),a||!r){console.error("❌ [fetchProject] Authentication failed in fresh check:",a),S("خطأ في المصادقة - يرجى تسجيل الدخول مرة أخرى"),t.push("/login");return}let i=await (0,u.G6)(s);if(console.log("\uD83D\uDCE6 getProjectById result:",i),i){let e={id:i.id,title:i.name,description:i.description,status:i.status,priority:i.priority,budget:i.budget,actual_cost:i.actual_cost,start_date:i.start_date,end_date:i.actual_completion_date,deadline:i.expected_completion_date,category:i.project_type,progress_percentage:i.progress_percentage,created_at:i.created_at,updated_at:i.updated_at,location:i.location};N(e),S(null),console.log("✅ Project loaded:",e)}else{console.log("\uD83D\uDD0D [fetchProject] getProjectById returned null, trying direct query...");let{data:t,error:a}=await e.from("projects").select("id, name, user_id, status, created_at").eq("id",s);if(console.log("\uD83D\uDCCA [fetchProject] Direct query result:",{directProject:t,directError:null==a?void 0:a.message,count:null==t?void 0:t.length}),t&&t.length>0){let e=t[0];console.log("\uD83D\uDCCB [fetchProject] Project exists but not accessible:",{projectId:e.id,projectUserId:e.user_id,currentUserId:r.id,match:e.user_id===r.id}),e.user_id!==r.id?S("ليس لديك صلاحية للوصول إلى هذا المشروع"):S("خطأ غير متوقع في تحميل المشروع")}else S("المشروع غير موجود (projectId: ".concat(s,", userId: ").concat(null==l?void 0:l.id,")"));N(null),console.log("❌ Project not found",{projectId:s,userId:null==l?void 0:l.id})}}catch(e){console.error("Error fetching project:",e,{projectId:s,userId:null==l?void 0:l.id}),S("حدث خطأ في تحميل بيانات المشروع"),N(null)}finally{w(!1)}},O=async()=>{if(B>=3)return void console.log("❌ Max retry attempts reached");console.log("\uD83D\uDD04 Retrying project fetch (attempt ".concat(B+1,"/3)...")),E(e=>e+1),await L()};return((0,a.useEffect)(()=>{if(y&&y.status&&I!==y.status){let e=b[y.status];e&&(D({type:"info",message:"نصيحة للمرحلة الحالية: ".concat(e)}),p.createNotification({user_id:(null==l?void 0:l.id)||"",type:f.PROJECT_UPDATED,title:"تقدم المشروع",message:"تم الانتقال إلى مرحلة: ".concat(y.status),data:{projectId:y.id,status:y.status},is_read:!1,priority:"normal",channel:"app",sent_at:new Date().toISOString()})),q(y.status)}},[null==y?void 0:y.status]),_)?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsx)(c.LoadingSpinner,{})}):P||C?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)(c.Card,{className:"p-6 text-center",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-red-600 mb-4",children:"خطأ"}),(0,r.jsx)("p",{className:"text-gray-600",children:P||C}),B<3&&(0,r.jsx)("button",{onClick:O,disabled:_,className:"mt-4 bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white px-4 py-2 rounded-lg transition-colors",children:_?"جاري إعادة المحاولة...":"إعادة المحاولة (".concat(B,"/3)")}),B>=3&&(0,r.jsx)("div",{className:"mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-lg",children:(0,r.jsx)("p",{className:"text-sm text-yellow-800",children:"تم استنفاد محاولات إعادة التحميل. يرجى التحقق من الاتصال بالإنترنت أو المحاولة لاحقاً."})}),(0,r.jsx)("button",{onClick:()=>t.back(),className:"mt-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors",children:"العودة"})]})}):y?(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,r.jsxs)("div",{className:"container mx-auto px-4 max-w-6xl",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,r.jsx)("button",{onClick:()=>t.back(),className:"p-2 hover:bg-gray-200 rounded-lg transition-colors",children:(0,r.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:y.title}),(0,r.jsx)("p",{className:"text-gray-600",children:"تفاصيل المشروع وحالة التقدم"})]})]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,r.jsx)(c.StatusBadge,{status:y.status,label:y.status}),(0,r.jsx)(c.StatusBadge,{status:y.priority,label:"أولوية ".concat("low"===y.priority?"منخفضة":"medium"===y.priority?"متوسطة":"high"===y.priority?"عالية":"عاجلة")})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,r.jsxs)("div",{className:"lg:col-span-2 space-y-6",children:[(0,r.jsxs)(c.Card,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"تفاصيل المشروع"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-2",children:"الوصف"}),(0,r.jsx)("p",{className:"text-gray-600",children:y.description})]}),y.category&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-2",children:"الفئة"}),(0,r.jsx)("p",{className:"text-gray-600",children:y.category})]})]})]}),(0,r.jsxs)(c.Card,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"تقدم المشروع"}),(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"النسبة المكتملة"}),(0,r.jsxs)("span",{className:"text-sm text-gray-600",children:[y.progress_percentage||0,"%"]})]})," ",(0,r.jsx)(c.ProgressBar,{percentage:y.progress_percentage||0,showLabel:!1})]})})]}),(0,r.jsxs)(c.Card,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"الإجراءات"}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4",children:[(0,r.jsxs)(o(),{href:"/user/projects/".concat(y.id,"/edit"),className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"تعديل المشروع"]}),(0,r.jsxs)("button",{className:"bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"تقرير التقدم"]})]})]})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)(c.Card,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"معلومات المشروع"}),(0,r.jsxs)("div",{className:"space-y-4",children:[y.budget&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"الميزانية المقدرة"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-green-600",children:h(y.budget)})]}),y.actual_cost&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"التكلفة الفعلية"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-blue-600",children:h(y.actual_cost)})]}),y.start_date&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"تاريخ البداية"}),(0,r.jsx)("p",{className:"text-gray-600",children:x(y.start_date)})]}),y.deadline&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"الموعد النهائي"}),(0,r.jsx)("p",{className:"text-gray-600",children:x(y.deadline)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"تاريخ الإنشاء"}),(0,r.jsx)("p",{className:"text-gray-600",children:x(y.created_at)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"آخر تحديث"}),(0,r.jsx)("p",{className:"text-gray-600",children:x(y.updated_at)})]}),y.location&&(()=>{let e=null;try{let t="string"==typeof y.location?JSON.parse(y.location):y.location;t&&"number"==typeof t.lat&&"number"==typeof t.lng&&(e={lat:t.lat,lng:t.lng})}catch(e){}return e?(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"font-medium text-gray-700 mb-1",children:"موقع المشروع على الخريطة"}),(0,r.jsx)("div",{className:"h-40 w-full border rounded-lg overflow-hidden mb-2",children:(0,r.jsx)(m,{initialLocation:e,readOnly:!0})}),(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["خط العرض: ",e.lat,", خط الطول: ",e.lng]})]}):null})()]})]}),(0,r.jsxs)(c.Card,{className:"p-6",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"مراحل البناء"}),(0,r.jsx)(v,{status:y.status}),b[y.status]&&(0,r.jsxs)("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg text-blue-800 text-sm",children:[(0,r.jsx)("span",{className:"font-bold",children:"نصيحة:"})," ",b[y.status]]})]})]})]})]})}):(0,r.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:(0,r.jsxs)(c.Card,{className:"p-6 text-center",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"المشروع غير موجود"}),(0,r.jsx)("p",{className:"text-gray-600",children:"لم يتم العثور على المشروع المطلوب"}),(0,r.jsx)(o(),{href:"/user/projects",className:"inline-block mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors",children:"العودة للمشاريع"})]})})}let N=[{value:"planning",label:"تخطيط"},{value:"design",label:"تصميم"},{value:"permits",label:"رخص"},{value:"construction",label:"تنفيذ"},{value:"finishing",label:"تشطيب"},{value:"completed",label:"مكتمل"}];function v(e){let{status:t}=e,s=N.findIndex(e=>e.value===t);return(0,r.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,r.jsx)("div",{className:"flex items-center gap-2",children:N.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ".concat(t<=s?"bg-blue-600":"bg-gray-300"),children:t+1}),t<N.length-1&&(0,r.jsx)("div",{className:"h-1 w-8 ".concat(t<s?"bg-blue-600":"bg-gray-200")})]},e.value))}),(0,r.jsx)("div",{className:"flex justify-between text-xs text-gray-700 mt-1",children:N.map(e=>(0,r.jsx)("span",{className:"w-8 text-center",children:e.label},e.value))})]})}},1521:()=>{},2523:(e,t,s)=>{"use strict";s(5155),s(2115)},5619:(e,t,s)=>{Promise.resolve().then(s.bind(s,714))},5848:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[77,834,180,441,684,358],()=>t(5619)),_N_E=e.O()}]);