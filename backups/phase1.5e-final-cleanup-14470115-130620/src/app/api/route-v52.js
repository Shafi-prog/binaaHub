(()=>{var e={};e.id=3312,e.ids=[3312],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5239:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>p,serverHooks:()=>v,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>l,POST:()=>d});var s=r(96559),n=r(48088),i=r(37719),o=r(32190),c=r(61223),u=r(44999),m=r(53292);async function l(e){try{let t=new URL(e.url),r=t.searchParams.get("paymentId"),a=t.searchParams.get("Id");if(!r)return o.NextResponse.redirect(new URL("/payment/error?reason=missing_payment_id",e.url));let s=(0,c.createRouteHandlerClient)({cookies:u.cookies}),n=await m.K.processCallback(r,"success");if(n.success){let{error:t}=await s.from("invoices").update({payment_status:"paid",payment_method:"fatoorah",payment_transaction_id:n.transactionId,payment_gateway_transaction_id:n.gatewayTransactionId,paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("invoice_number",r).or(`id.eq.${a}`),{data:i}=await s.from("invoices").select("store_id, buyer_name, total_amount, invoice_number").eq("invoice_number",r).or(`id.eq.${a}`).single();return i&&await s.from("notifications").insert({user_id:i.store_id,type:"payment_received",title:"تم استلام دفعة جديدة",message:`تم دفع فاتورة ${i.invoice_number} من العميل ${i.buyer_name} بقيمة ${i.total_amount} ريال`,data:{invoice_id:a,payment_amount:i.total_amount,customer_name:i.buyer_name},is_read:!1,priority:"normal",channel:"app"}),o.NextResponse.redirect(new URL(`/payment/success?invoice=${a||r}`,e.url))}return o.NextResponse.redirect(new URL("/payment/error?reason=payment_failed",e.url))}catch(t){return o.NextResponse.redirect(new URL("/payment/error?reason=processing_error",e.url))}}async function d(e){try{let{InvoiceId:t,InvoiceStatus:r,PaymentId:a}=await e.json(),s=(0,c.createRouteHandlerClient)({cookies:u.cookies}),n=await m.K.getPaymentStatusByInvoiceId(t);if(n.IsSuccess){let e="Paid"===n.Data.InvoiceStatus?"paid":"failed";return await s.from("invoices").update({payment_status:e,payment_method:"fatoorah",payment_transaction_id:a,paid_at:"paid"===e?new Date().toISOString():null,updated_at:new Date().toISOString()}).eq("id",t),o.NextResponse.json({success:!0})}return o.NextResponse.json({success:!1},{status:400})}catch(e){return o.NextResponse.json({error:"Webhook processing failed"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/fatoorah/callback/route",pathname:"/api/fatoorah/callback",filename:"route",bundlePath:"app/api/fatoorah/callback/route"},resolvedPagePath:"C:\\Users\\hp\\BinnaCodes\\binna\\src\\app\\api\\fatoorah\\callback\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:y,workUnitAsyncStorage:h,serverHooks:v}=p;function f(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:h})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},53292:(e,t,r)=>{"use strict";r.d(t,{K:()=>s});class a{constructor(){this.config={apiKey:process.env.FATOORAH_API_KEY||"",baseUrl:process.env.FATOORAH_BASE_URL||"https://apitest.myfatoorah.com",isTestMode:!1}}async makeRequest(e,t="GET",r){let a=`${this.config.baseUrl}${e}`,s={"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`};try{let e=await fetch(a,{method:t,headers:s,...r&&{body:JSON.stringify(r)}});if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw e}}async createPayment(e){try{return await this.makeRequest("/v2/SendPayment","POST",e)}catch(e){return{isSuccess:!1,message:"Failed to create payment",validationErrors:[{error:e instanceof Error?e.message:"Unknown error"}]}}}async getPaymentMethods(e,t="KWD"){try{let r=await this.makeRequest("/v2/InitiatePayment","POST",{InvoiceAmount:e,CurrencyIso:t});if(r.IsSuccess)return r.Data.PaymentMethods||[];return[]}catch(e){return[]}}async executePayment(e){try{return await this.makeRequest("/v2/ExecutePayment","POST",{InvoiceValue:e.invoiceValue,PaymentMethodId:e.paymentMethodId,CustomerName:e.customerName,CustomerEmail:e.customerEmail,CustomerMobile:e.customerMobile,DisplayCurrencyIso:e.displayCurrencyIso||"KWD",CallBackUrl:e.callBackUrl,ErrorUrl:e.errorUrl,Language:e.language||"en"})}catch(e){return{isSuccess:!1,message:"Failed to execute payment"}}}async getPaymentStatus(e){try{let t=await this.makeRequest(`/v2/getPaymentStatus?Key=${e}&KeyType=PaymentId`);if(t.IsSuccess)return t.Data;return null}catch(e){return null}}async handleCallback(e){try{if(!e.paymentId)throw Error("Invalid callback data: missing paymentId");let t=await this.getPaymentStatus(e.paymentId);if(!t)throw Error("Unable to verify payment status");return{paymentId:e.paymentId,invoiceId:t.invoiceId.toString(),invoiceStatus:t.invoiceStatus,invoiceReference:t.invoiceReference,customerReference:t.customerReference,invoiceValue:t.invoiceValue,paidAmount:t.paidAmount,dueAmount:t.dueAmount,currencyIso:t.currencyIso,focusTransaction:t.invoiceTransactions[0]||{}}}catch(e){return null}}async cancelPayment(e){try{return(await this.makeRequest("/v2/CancelToken","POST",{Key:e,KeyType:"PaymentId"})).IsSuccess||!1}catch(e){return!1}}async refundPayment(e){try{return(await this.makeRequest("/v2/MakeRefund","POST",{Key:e.paymentId,KeyType:"PaymentId",RefundChargeOnCustomer:!1,ServiceChargeOnCustomer:!1,Amount:e.refundAmount,Comment:e.refundReason})).IsSuccess||!1}catch(e){return!1}}async getInvoiceLink(e){try{let t=await this.makeRequest(`/v2/GetDirectPaymentGateway/${e}`);if(t.IsSuccess&&t.Data)return t.Data.PaymentURL;return null}catch(e){return null}}validateWebhookSignature(e,t){try{return"mock_signature"===t}catch(e){return!1}}async getSupportedCurrencies(){try{return["KWD","SAR","AED","QAR","BHD","OMR","JOD","EGP","USD","EUR"]}catch(e){return["KWD"]}}formatAmount(e,t="KWD"){let r={KWD:{decimals:3,symbol:"د.ك"},SAR:{decimals:2,symbol:"﷼"},AED:{decimals:2,symbol:"د.إ"},QAR:{decimals:2,symbol:"﷼"},USD:{decimals:2,symbol:"$"},EUR:{decimals:2,symbol:"€"}},a=r[t]||r.KWD,s=e.toFixed(a.decimals);return`${s} ${a.symbol}`}}let s=new a},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4243,580,9398,1223,4999],()=>r(5239));module.exports=a})();