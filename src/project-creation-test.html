<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار إنشاء المشروع</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-pass { border-left: 4px solid #4CAF50; background: #f8fff8; }
        .test-fail { border-left: 4px solid #f44336; background: #fff8f8; }
        .test-warning { border-left: 4px solid #ff9800; background: #fff8f0; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover { background: #1976D2; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 اختبار إنشاء المشروع</h1>
        <p>هذا الاختبار سيتحقق من عمل نظام إنشاء المشاريع</p>

        <div class="test-section test-pass">
            <h3>✅ اختبار 1: بيانات الاختبار</h3>
            <p>إعداد بيانات المشروع للاختبار</p>
            <button onclick="showTestData()">عرض بيانات الاختبار</button>
            <div id="testDataResult"></div>
        </div>

        <div class="test-section test-warning">
            <h3>⚠️ اختبار 2: فحص الاتصال</h3>
            <p>فحص الاتصال بقاعدة البيانات والمصادقة</p>
            <button onclick="testConnection()">فحص الاتصال</button>
            <div id="connectionResult"></div>
        </div>

        <div class="test-section test-warning">
            <h3>🗄️ اختبار 3: فحص قاعدة البيانات</h3>
            <p>فحص جدول المشاريع والأعمدة المطلوبة</p>
            <button onclick="testDatabaseSchema()">فحص القاعدة</button>
            <div id="schemaResult"></div>
        </div>

        <div class="test-section test-warning">
            <h3>🚀 اختبار 4: إنشاء مشروع تجريبي</h3>
            <p>إنشاء مشروع تجريبي للتأكد من عمل النظام</p>
            <button onclick="testProjectCreation()">إنشاء مشروع تجريبي</button>
            <div id="createResult"></div>
        </div>

        <div class="test-section">
            <h3>📋 اختبار 5: اختبار النموذج</h3>
            <p>اختبار نموذج إنشاء المشروع مباشرة</p>
            <button onclick="openProjectForm()">فتح نموذج المشروع</button>
            <button onclick="fillFormWithTestData()">ملء النموذج بالبيانات التجريبية</button>
        </div>

        <div class="test-section">
            <h3>📊 سجل الاختبارات</h3>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">مسح السجل</button>
            <button onclick="runAllTests()">تشغيل جميع الاختبارات</button>
        </div>
    </div>

    <script>
        // Test data
        const testProjectData = {
            name: "مشروع اختبار - " + new Date().toLocaleString('ar'),
            description: "مشروع تجريبي للتأكد من عمل النظام",
            project_type: "residential",
            status: "planning",
            budget: "150000",
            start_date: "2025-07-15",
            end_date: "2025-11-30",
            city: "الرياض",
            region: "منطقة الرياض",
            district: "العليا",
            country: "SA",
            lat: 24.7136,
            lng: 46.6753,
            priority: "medium",
            is_active: true
        };

        function log(message) {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString('ar');
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function showTestData() {
            const result = document.getElementById('testDataResult');
            result.innerHTML = `
                <div class="status success">
                    <strong>بيانات الاختبار:</strong>
                    <pre>${JSON.stringify(testProjectData, null, 2)}</pre>
                </div>
            `;
            log("✅ بيانات الاختبار جاهزة");
        }

        async function testConnection() {
            const result = document.getElementById('connectionResult');
            log("🔍 فحص الاتصال...");
            
            try {
                // Check if we can access the current page (basic connectivity)
                const response = await fetch(window.location.origin + '/user/projects/new');
                if (response.ok) {
                    result.innerHTML = `
                        <div class="status success">
                            ✅ الاتصال بالموقع يعمل بشكل صحيح
                        </div>
                    `;
                    log("✅ الاتصال بالموقع يعمل");
                } else {
                    throw new Error('فشل في الاتصال');
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="status error">
                        ❌ خطأ في الاتصال: ${error.message}
                    </div>
                `;
                log("❌ خطأ في الاتصال: " + error.message);
            }
        }

        async function testDatabaseSchema() {
            const result = document.getElementById('schemaResult');
            log("🗄️ فحص قاعدة البيانات...");
            
            // This is a simulation since we can't directly access Supabase from client-side
            const requiredFields = [
                'name', 'description', 'project_type', 'status', 'budget',
                'start_date', 'end_date', 'location_lat', 'location_lng'
            ];
            
            const enhancedFields = [
                'city', 'region', 'district', 'country', 'priority', 'is_active', 'image_url'
            ];
            
            result.innerHTML = `
                <div class="status warning">
                    <strong>فحص الجدول:</strong><br>
                    ✅ الحقول الأساسية: ${requiredFields.join(', ')}<br>
                    ⚠️ الحقول المحسنة: ${enhancedFields.join(', ')}<br>
                    💡 إذا لم يتم تطبيق Migration، ستحتاج لتشغيل URGENT_DATABASE_FIX.sql
                </div>
            `;
            log("🗄️ فحص القاعدة مكتمل");
        }

        async function testProjectCreation() {
            const result = document.getElementById('createResult');
            log("🚀 اختبار إنشاء مشروع...");
            
            try {
                // Simulate project creation by testing the form fields
                const formData = new FormData();
                Object.keys(testProjectData).forEach(key => {
                    formData.append(key, testProjectData[key]);
                });
                
                result.innerHTML = `
                    <div class="status success">
                        ✅ بيانات المشروع جاهزة للإرسال<br>
                        📝 اسم المشروع: ${testProjectData.name}<br>
                        💰 الميزانية: ${testProjectData.budget}<br>
                        📅 التواريخ: ${testProjectData.start_date} إلى ${testProjectData.end_date}<br>
                        📍 الموقع: ${testProjectData.city}, ${testProjectData.region}<br>
                        <strong>💡 لاختبار الإنشاء الفعلي، استخدم نموذج المشروع</strong>
                    </div>
                `;
                log("✅ اختبار إنشاء المشروع مكتمل");
            } catch (error) {
                result.innerHTML = `
                    <div class="status error">
                        ❌ خطأ في اختبار إنشاء المشروع: ${error.message}
                    </div>
                `;
                log("❌ خطأ في إنشاء المشروع: " + error.message);
            }
        }

        function openProjectForm() {
            window.open('/user/projects/new', '_blank');
            log("🔗 فتح نموذج المشروع في تبويب جديد");
        }

        function fillFormWithTestData() {
            // This would fill the form if we're on the same page
            const formInstructions = `
                <div class="status warning">
                    📋 تعليمات ملء النموذج:<br>
                    1. افتح نموذج المشروع<br>
                    2. املأ الحقول التالية:<br>
                    • اسم المشروع: ${testProjectData.name}<br>
                    • الوصف: ${testProjectData.description}<br>
                    • نوع المشروع: ${testProjectData.project_type}<br>
                    • الميزانية: ${testProjectData.budget}<br>
                    • تاريخ البداية: ${testProjectData.start_date}<br>
                    • تاريخ الانتهاء: ${testProjectData.end_date}<br>
                    • المدينة: ${testProjectData.city}<br>
                    • المنطقة: ${testProjectData.region}<br>
                    • الحي: ${testProjectData.district}<br>
                    3. اضغط "حفظ المشروع"<br>
                </div>
            `;
            
            document.getElementById('createResult').innerHTML = formInstructions;
            log("📋 تعليمات ملء النموذج معروضة");
        }

        async function runAllTests() {
            log("🏁 بدء تشغيل جميع الاختبارات...");
            showTestData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testDatabaseSchema();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testProjectCreation();
            log("🎉 جميع الاختبارات مكتملة!");
        }

        // Initialize
        log("🧪 اختبار إنشاء المشروع جاهز");
    </script>
</body>
</html>
