<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Authentication Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f0f4f8;
        direction: rtl;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .test-box {
        margin: 15px 0;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
      }
      .result {
        margin: 8px 0;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px 5px 5px 0;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 8px;
      }
      .online {
        background: #28a745;
      }
      .offline {
        background: #dc3545;
      }
      .loading {
        background: #ffc107;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .live-status {
        position: fixed;
        top: 20px;
        left: 20px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 12px;
      }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="live-status">
      <div>
        ğŸ“¡ Live Status: <span class="status-indicator loading" id="connectionStatus"></span>
      </div>
      <div id="authStatus">ğŸ” Checking...</div>
    </div>

    <div class="container">
      <h1>ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø±</h1>
      <p><strong>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„" ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­</p>

      <div class="test-box">
        <h2>ğŸš€ Ø®Ø·ÙˆØ© 1: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="user@example.com" />
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="password123" />
        <button onclick="performLogin()" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button onclick="performLogout()" id="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <div id="loginResults"></div>
      </div>

      <div class="test-box">
        <h2>ğŸ” Ø®Ø·ÙˆØ© 2: ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <button onclick="checkSessionImmediately()">ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙˆØ±Ø§Ù‹</button>
        <button onclick="checkSessionWithDelay()">ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©</button>
        <button onclick="simulateDashboardCheck()">Ù…Ø­Ø§ÙƒØ§Ø© ÙØ­Øµ Dashboard</button>
        <div id="sessionResults"></div>
      </div>

      <div class="test-box">
        <h2>ğŸŒ Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© Dashboard</h2>
        <button onclick="testDashboardPage()">Ø§Ø®ØªØ¨Ø§Ø± Dashboard Ù…Ø¨Ø§Ø´Ø±Ø©</button>
        <button onclick="openDashboardNewTab()">ÙØªØ­ Dashboard ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</button>
        <div id="dashboardResults"></div>
      </div>

      <div class="test-box">
        <h2>ğŸ”„ Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
        <button onclick="runDiagnostics()">ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„</button>
        <button onclick="checkStorageState()">ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
        <div id="diagnosticResults"></div>
      </div>

      <div class="test-box">
        <h2>ğŸ› ï¸ Ø®Ø·ÙˆØ© 5: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h2>
        <button onclick="applyFix()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­</button>
        <div id="fixResults"></div>
      </div>
    </div>

    <script>
      const supabaseUrl = 'https://dlunxrgldjmqjxrnbrpl.supabase.co';
      const supabaseKey =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdW54cmdsamRtcWp4cm5icnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1NTI5NjYsImV4cCI6MjA1MTEyODk2Nn0.K3xd_xTyFGMY0iJC7XVQzNHNLSGPgRh2y6TiFxR0rV8';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      let currentUser = null;

      function addResult(containerId, type, message, details = '') {
        const container = document.getElementById(containerId);
        const result = document.createElement('div');
        result.className = `result ${type}`;
        const timestamp = new Date().toLocaleTimeString('ar-SA');
        result.innerHTML = `
                <div><strong>${message}</strong> <small>(${timestamp})</small></div>
                ${details ? `<div style="margin-top: 5px; font-size: 12px;">${details}</div>` : ''}
            `;
        container.appendChild(result);
        container.scrollTop = container.scrollHeight;
      }

      function clearResults(containerId) {
        document.getElementById(containerId).innerHTML = '';
      }

      function updateAuthStatus(status, user = null) {
        const authStatus = document.getElementById('authStatus');
        const connectionStatus = document.getElementById('connectionStatus');

        if (status === 'authenticated' && user) {
          authStatus.textContent = `âœ… Ù…ØµØ§Ø¯Ù‚: ${user.email}`;
          connectionStatus.className = 'status-indicator online';
          currentUser = user;
        } else if (status === 'unauthenticated') {
          authStatus.textContent = 'âŒ ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚';
          connectionStatus.className = 'status-indicator offline';
          currentUser = null;
        } else {
          authStatus.textContent = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';
          connectionStatus.className = 'status-indicator loading';
        }
      }

      async function performLogin() {
        clearResults('loginResults');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        addResult('loginResults', 'info', 'Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', `Ø§Ù„Ø¨Ø±ÙŠØ¯: ${email}`);
        updateAuthStatus('checking');

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            addResult('loginResults', 'error', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', error.message);
            updateAuthStatus('unauthenticated');
            return false;
          }

          addResult(
            'loginResults',
            'success',
            'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!',
            `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.user.email}<br>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©: ${data.session.access_token.substring(0, 30)}...`,
          );

          updateAuthStatus('authenticated', data.user);
          return true;
        } catch (error) {
          addResult('loginResults', 'error', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', error.message);
          updateAuthStatus('unauthenticated');
          return false;
        }
      }

      async function performLogout() {
        addResult('loginResults', 'info', 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...');
        try {
          await supabase.auth.signOut();
          addResult('loginResults', 'success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
          updateAuthStatus('unauthenticated');
        } catch (error) {
          addResult('loginResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', error.message);
        }
      }

      async function checkSessionImmediately() {
        clearResults('sessionResults');
        addResult('sessionResults', 'info', 'ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙˆØ±Ø§Ù‹...');

        try {
          const { data, error } = await supabase.auth.getSession();

          if (error) {
            addResult('sessionResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø©', error.message);
          } else if (data.session) {
            addResult(
              'sessionResults',
              'success',
              'âœ… Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© ÙÙˆØ±Ø§Ù‹!',
              `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.session.user.email}`,
            );
          } else {
            addResult('sessionResults', 'error', 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© - Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©!');
          }
        } catch (error) {
          addResult('sessionResults', 'error', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', error.message);
        }
      }

      async function checkSessionWithDelay() {
        addResult('sessionResults', 'info', 'Ø§Ù†ØªØ¸Ø§Ø± 2 Ø«Ø§Ù†ÙŠØ© Ø«Ù… ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø©...');

        setTimeout(async () => {
          try {
            const { data, error } = await supabase.auth.getSession();

            if (error) {
              addResult(
                'sessionResults',
                'error',
                'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±)',
                error.message,
              );
            } else if (data.session) {
              addResult(
                'sessionResults',
                'success',
                'âœ… Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±',
                `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${data.session.user.email}`,
              );
            } else {
              addResult('sessionResults', 'warning', 'âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±');
            }
          } catch (error) {
            addResult('sessionResults', 'error', 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±)', error.message);
          }
        }, 2000);
      }

      async function simulateDashboardCheck() {
        addResult('sessionResults', 'info', 'Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù†Ø·Ù‚ Dashboard Ø§Ù„Ø­Ø§Ù„ÙŠ...');

        try {
          // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Dashboard
          let { data, error } = await supabase.auth.getSession();

          if (!data?.session && !error) {
            addResult(
              'sessionResults',
              'warning',
              'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ refreshSession...',
            );

            const refreshResult = await supabase.auth.refreshSession();
            if (refreshResult.data?.session) {
              addResult('sessionResults', 'success', 'ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
              data = refreshResult.data;
            } else {
              addResult('sessionResults', 'warning', 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ getUser...');

              const userResult = await supabase.auth.getUser();
              if (userResult.data?.user && !userResult.error) {
                addResult(
                  'sessionResults',
                  'success',
                  'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± getUser - ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ù…Ø¤Ù‚ØªØ©',
                );
              } else {
                addResult(
                  'sessionResults',
                  'error',
                  'ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª - Ø³ÙŠØ¸Ù‡Ø± "ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„"',
                );
              }
            }
          } else if (data?.session) {
            addResult(
              'sessionResults',
              'success',
              'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø¨Ø§Ø´Ø±Ø© - Dashboard Ø³ÙŠØ¹Ù…Ù„!',
            );
          } else {
            addResult('sessionResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ getSession', error.message);
          }
        } catch (error) {
          addResult('sessionResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©', error.message);
        }
      }

      async function testDashboardPage() {
        clearResults('dashboardResults');
        addResult('dashboardResults', 'info', 'Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© Dashboard...');

        try {
          const response = await fetch('http://localhost:3002/user/dashboard', {
            credentials: 'include',
          });

          if (response.ok) {
            const text = await response.text();
            if (text.includes('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„')) {
              addResult(
                'dashboardResults',
                'error',
                'âŒ Dashboard ØªØ¸Ù‡Ø± "ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„" - Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©!',
              );
            } else if (text.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ') || text.includes('Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')) {
              addResult('dashboardResults', 'success', 'âœ… Dashboard ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!');
            } else {
              addResult('dashboardResults', 'warning', 'Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Dashboard');
            }
          } else {
            addResult(
              'dashboardResults',
              'error',
              'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù€ Dashboard',
              `HTTP ${response.status}`,
            );
          }
        } catch (error) {
          if (error.message.includes('fetch')) {
            addResult(
              'dashboardResults',
              'error',
              'Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ npm run dev',
              'Ø§Ø³ØªØ®Ø¯Ù…: npm run dev',
            );
          } else {
            addResult('dashboardResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Dashboard', error.message);
          }
        }
      }

      function openDashboardNewTab() {
        addResult('dashboardResults', 'info', 'ÙØªØ­ Dashboard ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯...');
        window.open('http://localhost:3002/user/dashboard', '_blank');
      }

      async function runDiagnostics() {
        clearResults('diagnosticResults');
        addResult('diagnosticResults', 'info', 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø´Ø§Ù…Ù„...');

        // Test 1: Check current auth state
        const { data: sessionData } = await supabase.auth.getSession();
        addResult(
          'diagnosticResults',
          sessionData.session ? 'success' : 'error',
          `Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${sessionData.session ? 'Ù…ÙˆØ¬ÙˆØ¯Ø©' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}`,
        );

        // Test 2: Check storage
        const authToken = localStorage.getItem('sb-dlunxrgldjmqjxrnbrpl-auth-token');
        addResult(
          'diagnosticResults',
          authToken ? 'success' : 'warning',
          `Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${authToken ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`,
        );

        // Test 3: Check cookies
        const hasCookies = document.cookie.includes('sb-') || document.cookie.includes('supabase');
        addResult(
          'diagnosticResults',
          hasCookies ? 'success' : 'warning',
          `ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${hasCookies ? 'Ù…ÙˆØ¬ÙˆØ¯Ø©' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}`,
        );

        // Test 4: Network connectivity
        try {
          const pingResponse = await fetch(supabaseUrl + '/rest/v1/', { method: 'HEAD' });
          addResult(
            'diagnosticResults',
            pingResponse.ok ? 'success' : 'error',
            `Ø§ØªØµØ§Ù„ Supabase: ${pingResponse.ok ? 'Ù…ØªØµÙ„' : 'Ù…Ù†Ù‚Ø·Ø¹'}`,
          );
        } catch (error) {
          addResult('diagnosticResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase', error.message);
        }
      }

      function checkStorageState() {
        addResult('diagnosticResults', 'info', 'ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†...');

        // Check localStorage
        const localStorageKeys = Object.keys(localStorage).filter(
          (k) => k.includes('supabase') || k.includes('sb-') || k.includes('auth'),
        );

        if (localStorageKeys.length > 0) {
          const details = localStorageKeys
            .map((k) => `${k}: ${localStorage.getItem(k)?.substring(0, 50)}...`)
            .join('<br>');
          addResult('diagnosticResults', 'info', 'Ø¨ÙŠØ§Ù†Ø§Øª localStorage', details);
        } else {
          addResult('diagnosticResults', 'warning', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ localStorage');
        }

        // Check sessionStorage
        const sessionStorageKeys = Object.keys(sessionStorage).filter(
          (k) => k.includes('supabase') || k.includes('sb-') || k.includes('auth'),
        );

        if (sessionStorageKeys.length > 0) {
          addResult('diagnosticResults', 'info', 'Ø¨ÙŠØ§Ù†Ø§Øª sessionStorage Ù…ÙˆØ¬ÙˆØ¯Ø©');
        } else {
          addResult('diagnosticResults', 'info', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ sessionStorage');
        }
      }

      async function applyFix() {
        clearResults('fixResults');
        addResult('fixResults', 'info', 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­...');

        try {
          // Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù‚ÙˆØ©
          addResult('fixResults', 'info', 'Ø®Ø·ÙˆØ© 1: Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù„Ø³Ø©...');

          // Ù…Ø­Ùˆ Ø§Ù„ÙƒØ§Ø´
          localStorage.removeItem('sb-dlunxrgldjmqjxrnbrpl-auth-token');
          sessionStorage.clear();

          addResult('fixResults', 'success', 'ØªÙ… Ù…Ø­Ùˆ Ø§Ù„ÙƒØ§Ø´');

          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
          addResult('fixResults', 'info', 'Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
          const loginSuccess = await performLogin();

          if (loginSuccess) {
            addResult('fixResults', 'success', 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');

            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ø«Ù… ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø©
            setTimeout(async () => {
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                addResult('fixResults', 'success', 'âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù†Ø¬Ø­! Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†');
                addResult('fixResults', 'info', 'Ø¬Ø±Ø¨ ÙØªØ­ Dashboard Ø§Ù„Ø¢Ù†');
              } else {
                addResult('fixResults', 'error', 'âŒ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù… ÙŠÙ†Ø¬Ø­ØŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ø¹Ù…Ù‚');
              }
            }, 1000);
          } else {
            addResult('fixResults', 'error', 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
          }
        } catch (error) {
          addResult('fixResults', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', error.message);
        }
      }

      // Auto-initialize
      document.addEventListener('DOMContentLoaded', function () {
        updateAuthStatus('checking');

        // Check initial state
        supabase.auth.getSession().then(({ data }) => {
          if (data.session) {
            updateAuthStatus('authenticated', data.session.user);
          } else {
            updateAuthStatus('unauthenticated');
          }
        });

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
          console.log('Auth state changed:', event, session?.user?.email);

          if (event === 'SIGNED_IN' && session) {
            updateAuthStatus('authenticated', session.user);
          } else if (event === 'SIGNED_OUT') {
            updateAuthStatus('unauthenticated');
          }
        });
      });
    </script>
  </body>
</html>
