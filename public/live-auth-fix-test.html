<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Authentication Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f0f4f8;
        direction: rtl;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .test-box {
        margin: 15px 0;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
      }
      .result {
        margin: 8px 0;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px 5px 5px 0;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-left: 8px;
      }
      .online {
        background: #28a745;
      }
      .offline {
        background: #dc3545;
      }
      .loading {
        background: #ffc107;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .live-status {
        position: fixed;
        top: 20px;
        left: 20px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 12px;
      }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="live-status">
      <div>
        📡 Live Status: <span class="status-indicator loading" id="connectionStatus"></span>
      </div>
      <div id="authStatus">🔍 Checking...</div>
    </div>

    <div class="container">
      <h1>🔧 إصلاح مشكلة المصادقة - اختبار مباشر</h1>
      <p><strong>المشكلة:</strong> "المستخدم غير مسجل الدخول" يظهر بعد تسجيل الدخول الناجح</p>

      <div class="test-box">
        <h2>🚀 خطوة 1: تسجيل الدخول</h2>
        <input type="email" id="email" placeholder="البريد الإلكتروني" value="user@example.com" />
        <input type="password" id="password" placeholder="كلمة المرور" value="password123" />
        <button onclick="performLogin()" id="loginBtn">تسجيل الدخول</button>
        <button onclick="performLogout()" id="logoutBtn">تسجيل الخروج</button>
        <div id="loginResults"></div>
      </div>

      <div class="test-box">
        <h2>🔍 خطوة 2: فحص الجلسة بعد تسجيل الدخول</h2>
        <button onclick="checkSessionImmediately()">فحص الجلسة فوراً</button>
        <button onclick="checkSessionWithDelay()">فحص الجلسة بعد 2 ثانية</button>
        <button onclick="simulateDashboardCheck()">محاكاة فحص Dashboard</button>
        <div id="sessionResults"></div>
      </div>

      <div class="test-box">
        <h2>🌐 خطوة 3: اختبار صفحة Dashboard</h2>
        <button onclick="testDashboardPage()">اختبار Dashboard مباشرة</button>
        <button onclick="openDashboardNewTab()">فتح Dashboard في تبويب جديد</button>
        <div id="dashboardResults"></div>
      </div>

      <div class="test-box">
        <h2>🔄 خطوة 4: التشخيص المتقدم</h2>
        <button onclick="runDiagnostics()">تشغيل التشخيص الشامل</button>
        <button onclick="checkStorageState()">فحص حالة التخزين</button>
        <div id="diagnosticResults"></div>
      </div>

      <div class="test-box">
        <h2>🛠️ خطوة 5: تطبيق الإصلاح</h2>
        <button onclick="applyFix()">تطبيق الإصلاح المقترح</button>
        <div id="fixResults"></div>
      </div>
    </div>

    <script>
      const supabaseUrl = 'https://dlunxrgldjmqjxrnbrpl.supabase.co';
      const supabaseKey =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdW54cmdsamRtcWp4cm5icnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU1NTI5NjYsImV4cCI6MjA1MTEyODk2Nn0.K3xd_xTyFGMY0iJC7XVQzNHNLSGPgRh2y6TiFxR0rV8';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      let currentUser = null;

      function addResult(containerId, type, message, details = '') {
        const container = document.getElementById(containerId);
        const result = document.createElement('div');
        result.className = `result ${type}`;
        const timestamp = new Date().toLocaleTimeString('ar-SA');
        result.innerHTML = `
                <div><strong>${message}</strong> <small>(${timestamp})</small></div>
                ${details ? `<div style="margin-top: 5px; font-size: 12px;">${details}</div>` : ''}
            `;
        container.appendChild(result);
        container.scrollTop = container.scrollHeight;
      }

      function clearResults(containerId) {
        document.getElementById(containerId).innerHTML = '';
      }

      function updateAuthStatus(status, user = null) {
        const authStatus = document.getElementById('authStatus');
        const connectionStatus = document.getElementById('connectionStatus');

        if (status === 'authenticated' && user) {
          authStatus.textContent = `✅ مصادق: ${user.email}`;
          connectionStatus.className = 'status-indicator online';
          currentUser = user;
        } else if (status === 'unauthenticated') {
          authStatus.textContent = '❌ غير مصادق';
          connectionStatus.className = 'status-indicator offline';
          currentUser = null;
        } else {
          authStatus.textContent = '🔍 جاري الفحص...';
          connectionStatus.className = 'status-indicator loading';
        }
      }

      async function performLogin() {
        clearResults('loginResults');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        addResult('loginResults', 'info', 'بدء تسجيل الدخول...', `البريد: ${email}`);
        updateAuthStatus('checking');

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            addResult('loginResults', 'error', 'فشل تسجيل الدخول', error.message);
            updateAuthStatus('unauthenticated');
            return false;
          }

          addResult(
            'loginResults',
            'success',
            'تم تسجيل الدخول بنجاح!',
            `المستخدم: ${data.user.email}<br>معرف الجلسة: ${data.session.access_token.substring(0, 30)}...`,
          );

          updateAuthStatus('authenticated', data.user);
          return true;
        } catch (error) {
          addResult('loginResults', 'error', 'خطأ غير متوقع', error.message);
          updateAuthStatus('unauthenticated');
          return false;
        }
      }

      async function performLogout() {
        addResult('loginResults', 'info', 'تسجيل الخروج...');
        try {
          await supabase.auth.signOut();
          addResult('loginResults', 'success', 'تم تسجيل الخروج');
          updateAuthStatus('unauthenticated');
        } catch (error) {
          addResult('loginResults', 'error', 'خطأ في تسجيل الخروج', error.message);
        }
      }

      async function checkSessionImmediately() {
        clearResults('sessionResults');
        addResult('sessionResults', 'info', 'فحص الجلسة فوراً...');

        try {
          const { data, error } = await supabase.auth.getSession();

          if (error) {
            addResult('sessionResults', 'error', 'خطأ في جلب الجلسة', error.message);
          } else if (data.session) {
            addResult(
              'sessionResults',
              'success',
              '✅ الجلسة متاحة فوراً!',
              `المستخدم: ${data.session.user.email}`,
            );
          } else {
            addResult('sessionResults', 'error', '❌ لا توجد جلسة - هذه هي المشكلة!');
          }
        } catch (error) {
          addResult('sessionResults', 'error', 'خطأ غير متوقع', error.message);
        }
      }

      async function checkSessionWithDelay() {
        addResult('sessionResults', 'info', 'انتظار 2 ثانية ثم فحص الجلسة...');

        setTimeout(async () => {
          try {
            const { data, error } = await supabase.auth.getSession();

            if (error) {
              addResult(
                'sessionResults',
                'error',
                'خطأ في جلب الجلسة (بعد التأخير)',
                error.message,
              );
            } else if (data.session) {
              addResult(
                'sessionResults',
                'success',
                '✅ الجلسة متاحة بعد التأخير',
                `المستخدم: ${data.session.user.email}`,
              );
            } else {
              addResult('sessionResults', 'warning', '⚠️ لا توجد جلسة حتى بعد التأخير');
            }
          } catch (error) {
            addResult('sessionResults', 'error', 'خطأ غير متوقع (بعد التأخير)', error.message);
          }
        }, 2000);
      }

      async function simulateDashboardCheck() {
        addResult('sessionResults', 'info', 'محاكاة منطق Dashboard الحالي...');

        try {
          // هذا هو المنطق الموجود في Dashboard
          let { data, error } = await supabase.auth.getSession();

          if (!data?.session && !error) {
            addResult(
              'sessionResults',
              'warning',
              'لا توجد جلسة، جاري المحاولة مع refreshSession...',
            );

            const refreshResult = await supabase.auth.refreshSession();
            if (refreshResult.data?.session) {
              addResult('sessionResults', 'success', 'تم استرداد الجلسة بعد التحديث');
              data = refreshResult.data;
            } else {
              addResult('sessionResults', 'warning', 'فشل التحديث، جاري المحاولة مع getUser...');

              const userResult = await supabase.auth.getUser();
              if (userResult.data?.user && !userResult.error) {
                addResult(
                  'sessionResults',
                  'success',
                  'تم العثور على المستخدم عبر getUser - يمكن إنشاء جلسة مؤقتة',
                );
              } else {
                addResult(
                  'sessionResults',
                  'error',
                  'فشل في جميع المحاولات - سيظهر "غير مسجل الدخول"',
                );
              }
            }
          } else if (data?.session) {
            addResult(
              'sessionResults',
              'success',
              'تم العثور على الجلسة مباشرة - Dashboard سيعمل!',
            );
          } else {
            addResult('sessionResults', 'error', 'خطأ في getSession', error.message);
          }
        } catch (error) {
          addResult('sessionResults', 'error', 'خطأ في المحاكاة', error.message);
        }
      }

      async function testDashboardPage() {
        clearResults('dashboardResults');
        addResult('dashboardResults', 'info', 'اختبار صفحة Dashboard...');

        try {
          const response = await fetch('http://localhost:3002/user/dashboard', {
            credentials: 'include',
          });

          if (response.ok) {
            const text = await response.text();
            if (text.includes('المستخدم غير مسجل الدخول')) {
              addResult(
                'dashboardResults',
                'error',
                '❌ Dashboard تظهر "غير مسجل الدخول" - المشكلة موجودة!',
              );
            } else if (text.includes('مرحباً بك') || text.includes('لوحة تحكم المستخدم')) {
              addResult('dashboardResults', 'success', '✅ Dashboard تعمل بشكل صحيح!');
            } else {
              addResult('dashboardResults', 'warning', 'محتوى غير متوقع في Dashboard');
            }
          } else {
            addResult(
              'dashboardResults',
              'error',
              'خطأ في الوصول للـ Dashboard',
              `HTTP ${response.status}`,
            );
          }
        } catch (error) {
          if (error.message.includes('fetch')) {
            addResult(
              'dashboardResults',
              'error',
              'الخادم غير متاح - تأكد من تشغيل npm run dev',
              'استخدم: npm run dev',
            );
          } else {
            addResult('dashboardResults', 'error', 'خطأ في اختبار Dashboard', error.message);
          }
        }
      }

      function openDashboardNewTab() {
        addResult('dashboardResults', 'info', 'فتح Dashboard في تبويب جديد...');
        window.open('http://localhost:3002/user/dashboard', '_blank');
      }

      async function runDiagnostics() {
        clearResults('diagnosticResults');
        addResult('diagnosticResults', 'info', 'بدء التشخيص الشامل...');

        // Test 1: Check current auth state
        const { data: sessionData } = await supabase.auth.getSession();
        addResult(
          'diagnosticResults',
          sessionData.session ? 'success' : 'error',
          `حالة الجلسة الحالية: ${sessionData.session ? 'موجودة' : 'غير موجودة'}`,
        );

        // Test 2: Check storage
        const authToken = localStorage.getItem('sb-dlunxrgldjmqjxrnbrpl-auth-token');
        addResult(
          'diagnosticResults',
          authToken ? 'success' : 'warning',
          `رمز المصادقة في التخزين: ${authToken ? 'موجود' : 'غير موجود'}`,
        );

        // Test 3: Check cookies
        const hasCookies = document.cookie.includes('sb-') || document.cookie.includes('supabase');
        addResult(
          'diagnosticResults',
          hasCookies ? 'success' : 'warning',
          `كوكيز المصادقة: ${hasCookies ? 'موجودة' : 'غير موجودة'}`,
        );

        // Test 4: Network connectivity
        try {
          const pingResponse = await fetch(supabaseUrl + '/rest/v1/', { method: 'HEAD' });
          addResult(
            'diagnosticResults',
            pingResponse.ok ? 'success' : 'error',
            `اتصال Supabase: ${pingResponse.ok ? 'متصل' : 'منقطع'}`,
          );
        } catch (error) {
          addResult('diagnosticResults', 'error', 'خطأ في الاتصال بـ Supabase', error.message);
        }
      }

      function checkStorageState() {
        addResult('diagnosticResults', 'info', 'فحص حالة التخزين...');

        // Check localStorage
        const localStorageKeys = Object.keys(localStorage).filter(
          (k) => k.includes('supabase') || k.includes('sb-') || k.includes('auth'),
        );

        if (localStorageKeys.length > 0) {
          const details = localStorageKeys
            .map((k) => `${k}: ${localStorage.getItem(k)?.substring(0, 50)}...`)
            .join('<br>');
          addResult('diagnosticResults', 'info', 'بيانات localStorage', details);
        } else {
          addResult('diagnosticResults', 'warning', 'لا توجد بيانات مصادقة في localStorage');
        }

        // Check sessionStorage
        const sessionStorageKeys = Object.keys(sessionStorage).filter(
          (k) => k.includes('supabase') || k.includes('sb-') || k.includes('auth'),
        );

        if (sessionStorageKeys.length > 0) {
          addResult('diagnosticResults', 'info', 'بيانات sessionStorage موجودة');
        } else {
          addResult('diagnosticResults', 'info', 'لا توجد بيانات في sessionStorage');
        }
      }

      async function applyFix() {
        clearResults('fixResults');
        addResult('fixResults', 'info', 'تطبيق الإصلاح المقترح...');

        try {
          // الإصلاح المقترح: إعادة تعيين الجلسة بقوة
          addResult('fixResults', 'info', 'خطوة 1: إعادة تعيين الجلسة...');

          // محو الكاش
          localStorage.removeItem('sb-dlunxrgldjmqjxrnbrpl-auth-token');
          sessionStorage.clear();

          addResult('fixResults', 'success', 'تم محو الكاش');

          // إعادة تسجيل الدخول
          addResult('fixResults', 'info', 'خطوة 2: إعادة تسجيل الدخول...');
          const loginSuccess = await performLogin();

          if (loginSuccess) {
            addResult('fixResults', 'success', 'تم إعادة تسجيل الدخول');

            // انتظار قصير ثم فحص الجلسة
            setTimeout(async () => {
              const { data } = await supabase.auth.getSession();
              if (data.session) {
                addResult('fixResults', 'success', '✅ الإصلاح نجح! الجلسة متاحة الآن');
                addResult('fixResults', 'info', 'جرب فتح Dashboard الآن');
              } else {
                addResult('fixResults', 'error', '❌ الإصلاح لم ينجح، المشكلة أعمق');
              }
            }, 1000);
          } else {
            addResult('fixResults', 'error', 'فشل في إعادة تسجيل الدخول');
          }
        } catch (error) {
          addResult('fixResults', 'error', 'خطأ في تطبيق الإصلاح', error.message);
        }
      }

      // Auto-initialize
      document.addEventListener('DOMContentLoaded', function () {
        updateAuthStatus('checking');

        // Check initial state
        supabase.auth.getSession().then(({ data }) => {
          if (data.session) {
            updateAuthStatus('authenticated', data.session.user);
          } else {
            updateAuthStatus('unauthenticated');
          }
        });

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
          console.log('Auth state changed:', event, session?.user?.email);

          if (event === 'SIGNED_IN' && session) {
            updateAuthStatus('authenticated', session.user);
          } else if (event === 'SIGNED_OUT') {
            updateAuthStatus('unauthenticated');
          }
        });
      });
    </script>
  </body>
</html>
