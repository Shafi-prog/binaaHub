<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµØ§Ø¯Ù‚Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid;
      }
      .success {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
      }
      .info {
        background: #cce7ff;
        border-color: #b3d9ff;
        color: #004085;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      #log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ù…ØµØ§Ø¯Ù‚Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h1>

      <div class="status info">
        <strong>Ù‡Ø¯Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¨Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ ØµÙØ­Ø© "/user/projects/new" Ø¥Ù„Ù‰ ØµÙØ­Ø©
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      </div>

      <div id="authStatus" class="status warning">â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...</div>

      <div style="margin: 20px 0">
        <button onclick="checkAuth()" class="btn-primary">ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
        <button onclick="testLoginFlow()" class="btn-success">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ØªØ¯ÙÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button onclick="testNewProjectAccess()" class="btn-warning">
          ğŸ†• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        </button>
        <button onclick="diagnoseMiddleware()" class="btn-danger">ğŸ”§ ØªØ´Ø®ÙŠØµ Middleware</button>
        <button
          onclick="clearLog()"
          class="btn-secondary"
          style="background: #6c757d; color: white"
        >
          ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
        </button>
      </div>

      <div id="testResults"></div>

      <h3>ğŸ” Ø³Ø¬Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…ÙØµÙ„:</h3>
      <div id="log"></div>
    </div>

    <script>
      const log = document.getElementById('log');
      const authStatus = document.getElementById('authStatus');
      const testResults = document.getElementById('testResults');

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleString('ar-SA');
        const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
        log.textContent += logEntry;
        log.scrollTop = log.scrollHeight;
        console.log(logEntry);
      }

      function clearLog() {
        log.textContent = '';
        testResults.innerHTML = '';
      }

      function updateStatus(message, type) {
        authStatus.className = `status ${type}`;
        authStatus.innerHTML = message;
      }

      function addResult(title, status, details) {
        const result = document.createElement('div');
        result.className = `status ${status}`;
        result.innerHTML = `<strong>${title}:</strong> ${details}`;
        testResults.appendChild(result);
      }

      async function checkAuth() {
        addLog('ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');

        try {
          // Check cookies
          const cookies = document.cookie;
          addLog(`ğŸª Cookies Ø§Ù„Ù…ØªØ§Ø­Ø©: ${cookies.length > 0 ? 'Ù…ÙˆØ¬ÙˆØ¯Ø©' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'}`);

          // Check for Supabase auth cookies
          const authCookies = cookies
            .split(';')
            .filter((c) => c.includes('sb-') || c.includes('supabase') || c.includes('auth'));
          addLog(`ğŸ”‘ Auth cookies: ${authCookies.length} Ù…ÙˆØ¬ÙˆØ¯Ø©`);
          authCookies.forEach((cookie) => {
            const [name] = cookie.trim().split('=');
            addLog(`   - ${name}`);
          });

          // Try to fetch auth status from diagnostic endpoint
          const response = await fetch('/auth-diagnostic');
          const text = await response.text();

          if (response.ok) {
            addLog('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ');

            // Check if we're authenticated by looking for specific text
            if (text.includes('User authenticated') || text.includes('âœ…')) {
              updateStatus('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
              addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'success', 'Ù…ØµØ§Ø¯Ù‚ ÙˆÙ…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
            } else if (text.includes('Not authenticated') || text.includes('âŒ')) {
              updateStatus('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚', 'error');
              addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error', 'ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©');
            } else {
              updateStatus('âš ï¸ Ø­Ø§Ù„Ø© Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©', 'warning');
              addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'warning', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨ÙˆØ¶ÙˆØ­');
            }
          } else {
            addLog(`âŒ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ: ${response.status}`);
            updateStatus('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error');
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ${error.message}`);
          updateStatus('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error');
          addResult('ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function testLoginFlow() {
        addLog('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± ØªØ¯ÙÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');

        const email = 'test@example.com'; // Replace with actual test email
        const password = 'test123456'; // Replace with actual test password

        try {
          const response = await fetch('/login', {
            method: 'GET',
          });

          if (response.ok) {
            addLog('âœ… ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ØªØ§Ø­Ø©');
            addResult('ğŸ“ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success', 'Ù…ØªØ§Ø­Ø© ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§');
          } else {
            addLog(`âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${response.status}`);
            addResult('ğŸ“ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error', `Ø®Ø·Ø£ HTTP ${response.status}`);
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`);
          addResult('ğŸ“ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function testNewProjectAccess() {
        addLog('ğŸ†• Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');

        try {
          const response = await fetch('/user/projects/new', {
            method: 'GET',
            redirect: 'manual', // Don't follow redirects automatically
          });

          addLog(`ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status} ${response.statusText}`);

          if (response.status === 200) {
            addLog('âœ… Ù†Ø¬Ø­ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
            addResult('ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'success', 'Ù…ØªØ§Ø­Ø© ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§');
          } else if (response.status === 307 || response.status === 302) {
            const location = response.headers.get('location');
            addLog(`ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰: ${location}`);

            if (location === '/login') {
              addResult(
                'ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
                'error',
                'ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©'
              );
            } else {
              addResult('ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'warning', `Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰: ${location}`);
            }
          } else {
            addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„: ${response.status}`);
            addResult('ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'error', `Ø®Ø·Ø£ HTTP ${response.status}`);
          }

          // Test headers
          const headers = {};
          response.headers.forEach((value, key) => {
            headers[key] = value;
          });
          addLog(`ğŸ“‹ Headers: ${JSON.stringify(headers, null, 2)}`);
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„: ${error.message}`);
          addResult('ğŸ†• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      async function diagnoseMiddleware() {
        addLog('ğŸ”§ ØªØ´Ø®ÙŠØµ Middleware...');

        try {
          // Test various protected routes to see middleware behavior
          const testRoutes = [
            '/user/dashboard',
            '/user/projects',
            '/user/projects/new',
            '/user/profile',
          ];

          for (const route of testRoutes) {
            addLog(`ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±: ${route}`);

            const response = await fetch(route, {
              method: 'GET',
              redirect: 'manual',
            });

            const status = response.status;
            const location = response.headers.get('location');

            if (status === 200) {
              addLog(`âœ… ${route}: ÙˆØµÙˆÙ„ Ù†Ø§Ø¬Ø­`);
              addResult(`ğŸ›¡ï¸ ${route}`, 'success', 'Ù…Ø³Ù…ÙˆØ­ Ø§Ù„ÙˆØµÙˆÙ„');
            } else if (status === 307 || status === 302) {
              addLog(`ğŸ”„ ${route}: Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${location}`);
              if (location === '/login') {
                addResult(`ğŸ›¡ï¸ ${route}`, 'error', 'Ù…Ø±ÙÙˆØ¶ - Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
              } else {
                addResult(`ğŸ›¡ï¸ ${route}`, 'warning', `Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${location}`);
              }
            } else {
              addLog(`âŒ ${route}: Ø®Ø·Ø£ ${status}`);
              addResult(`ğŸ›¡ï¸ ${route}`, 'error', `Ø®Ø·Ø£ HTTP ${status}`);
            }
          }
        } catch (error) {
          addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´Ø®ÙŠØµ Middleware: ${error.message}`);
          addResult('ğŸ”§ ØªØ´Ø®ÙŠØµ Middleware', 'error', `Ø®Ø·Ø£: ${error.message}`);
        }
      }

      // Run initial check
      checkAuth();
    </script>
  </body>
</html>
