<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>اختبار إصلاح مشاكل المصادقة</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
        direction: rtl;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .warning {
        border-left-color: #ffc107;
        background: #fff3cd;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔧 اختبار إصلاح مشاكل المصادقة</h1>
      <p>هذا الاختبار يتحقق من حل مشاكل "خطأ في المصادقة" و "المستخدم غير مسجل الدخول"</p>

      <div class="test-section">
        <h3>1️⃣ اختبار تسجيل الدخول</h3>
        <button onclick="testLogin()">اختبار تسجيل الدخول</button>
      </div>

      <div class="test-section">
        <h3>2️⃣ اختبار الوصول للصفحات المحمية</h3>
        <button onclick="testProtectedRoutes()">اختبار المسارات المحمية</button>
      </div>

      <div class="test-section">
        <h3>3️⃣ اختبار إنشاء مشروع جديد</h3>
        <button onclick="testNewProject()">اختبار "new project"</button>
      </div>
      <div class="test-section">
        <h3>4️⃣ اختبار الملف الشخصي</h3>
        <button onclick="testUserProfile()">اختبار صفحة الملف الشخصي</button>
      </div>

      <div class="test-section">
        <h3>5️⃣ اختبار لوحة تحكم المتجر</h3>
        <button onclick="testStoreDashboard()">اختبار لوحة تحكم المتجر</button>
      </div>

      <div class="test-section">
        <h3>6️⃣ اختبار شامل</h3>
        <button onclick="runFullTest()">تشغيل الاختبار الشامل</button>
        <button onclick="clearLog()">مسح السجل</button>
      </div>

      <div id="log" class="log"></div>
    </div>

    <script>
      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString('ar-SA');
        const colors = {
          info: '#007bff',
          success: '#28a745',
          error: '#dc3545',
          warning: '#ffc107',
        };
        logDiv.innerHTML += `<div style="color: ${colors[type] || colors.info};">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
      }

      async function testLogin() {
        log('🔐 بدء اختبار تسجيل الدخول...', 'info');

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'user@user.com',
              password: '123456',
            }),
            credentials: 'include',
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            log(`✅ تم تسجيل الدخول بنجاح للمستخدم: ${result.user.email}`, 'success');
            log(`🎯 صفحة التوجيه: ${result.redirectTo}`, 'info');

            // Store login status for other tests
            window.userLoggedIn = true;
            window.userEmail = result.user.email;
          } else {
            log(`❌ فشل تسجيل الدخول: ${result.error}`, 'error');
          }
        } catch (error) {
          log(`❌ خطأ في تسجيل الدخول: ${error.message}`, 'error');
        }
      }

      async function testProtectedRoutes() {
        log('🔐 اختبار الوصول للمسارات المحمية...', 'info');
        const routes = [
          '/user/dashboard',
          '/user/profile',
          '/user/projects',
          '/user/projects/new',
          '/user/orders',
          '/store/dashboard',
        ];

        for (const route of routes) {
          try {
            log(`🔍 اختبار المسار: ${route}`, 'info');

            const response = await fetch(route, {
              credentials: 'include',
              redirect: 'manual',
            });

            if (response.status === 200) {
              log(`✅ ${route} - الوصول متاح`, 'success');
            } else if (response.status === 302 || response.status === 307) {
              const redirectLocation = response.headers.get('location');
              if (redirectLocation && redirectLocation.includes('/login')) {
                log(`❌ ${route} - تم التوجيه لصفحة تسجيل الدخول`, 'error');
              } else {
                log(`🔄 ${route} - توجيه إلى: ${redirectLocation}`, 'warning');
              }
            } else {
              log(`⚠️ ${route} - حالة غير متوقعة: ${response.status}`, 'warning');
            }
          } catch (error) {
            log(`❌ خطأ في اختبار ${route}: ${error.message}`, 'error');
          }

          // Small delay between requests
          await new Promise((resolve) => setTimeout(resolve, 500));
        }
      }

      async function testNewProject() {
        log('📋 اختبار صفحة إنشاء مشروع جديد...', 'info');

        try {
          const response = await fetch('/user/projects/new', {
            credentials: 'include',
            redirect: 'manual',
          });

          if (response.status === 200) {
            log('✅ صفحة إنشاء المشروع متاحة - تم حل مشكلة "خطأ في المصادقة"', 'success');
          } else if (response.status === 302 || response.status === 307) {
            const redirectLocation = response.headers.get('location');
            if (redirectLocation && redirectLocation.includes('/login')) {
              log('❌ لا يزال هناك مشكلة - يتم التوجيه لصفحة تسجيل الدخول', 'error');
            } else {
              log(`🔄 توجيه إلى: ${redirectLocation}`, 'warning');
            }
          }
        } catch (error) {
          log(`❌ خطأ في اختبار صفحة المشروع الجديد: ${error.message}`, 'error');
        }
      }

      async function testUserProfile() {
        log('👤 اختبار صفحة الملف الشخصي...', 'info');

        try {
          const response = await fetch('/user/profile', {
            credentials: 'include',
            redirect: 'manual',
          });

          if (response.status === 200) {
            log('✅ صفحة الملف الشخصي متاحة - تم حل مشكلة "المستخدم غير مسجل الدخول"', 'success');
          } else if (response.status === 302 || response.status === 307) {
            const redirectLocation = response.headers.get('location');
            if (redirectLocation && redirectLocation.includes('/login')) {
              log('❌ لا يزال هناك مشكلة - يتم التوجيه لصفحة تسجيل الدخول', 'error');
            } else {
              log(`🔄 توجيه إلى: ${redirectLocation}`, 'warning');
            }
          }
        } catch (error) {
          log(`❌ خطأ في اختبار صفحة الملف الشخصي: ${error.message}`, 'error');
        }
      }

      async function testStoreDashboard() {
        log('🏪 اختبار لوحة تحكم المتجر...', 'info');

        try {
          const response = await fetch('/store/dashboard', {
            credentials: 'include',
            redirect: 'manual',
          });

          if (response.status === 200) {
            log('✅ لوحة تحكم المتجر متاحة - تم إصلاح مشاكل المصادقة', 'success');
          } else if (response.status === 302 || response.status === 307) {
            const redirectLocation = response.headers.get('location');
            if (redirectLocation && redirectLocation.includes('/login')) {
              log('❌ لا يزال هناك مشكلة - يتم التوجيه لصفحة تسجيل الدخول', 'error');
            } else {
              log(`🔄 توجيه إلى: ${redirectLocation}`, 'warning');
            }
          }
        } catch (error) {
          log(`❌ خطأ في اختبار لوحة تحكم المتجر: ${error.message}`, 'error');
        }
      }

      async function runFullTest() {
        log('🚀 بدء الاختبار الشامل لحل مشاكل المصادقة...', 'info');
        log('='.repeat(60), 'info');

        await testLogin();

        // Wait for login to complete
        await new Promise((resolve) => setTimeout(resolve, 2000));
        await testProtectedRoutes();
        await testNewProject();
        await testUserProfile();
        await testStoreDashboard();

        log('='.repeat(60), 'info');
        log('🎉 اكتمل الاختبار الشامل!', 'info');

        if (window.userLoggedIn) {
          log('📊 النتيجة: تم تسجيل الدخول بنجاح', 'success');
          log('🔗 يمكنك الآن اختبار الصفحات يدوياً', 'info');
        } else {
          log('📊 النتيجة: هناك مشاكل في تسجيل الدخول تحتاج لحل', 'error');
        }
      }

      // Auto-run check on page load
      window.addEventListener('load', () => {
        log('🔧 تم تحميل صفحة اختبار إصلاح المصادقة', 'info');
        log('📝 استخدم الأزرار أعلاه لاختبار جوانب مختلفة من النظام', 'info');
      });
    </script>
  </body>
</html>
