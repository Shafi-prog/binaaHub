(()=>{var e={};e.id=3070,e.ids=[3070],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},87305:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>l,serverHooks:()=>_,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{GET:()=>u});var a=r(96559),o=r(48088),i=r(37719),n=r(32190),d=r(44999),c=r(61223);async function u(e){try{let t=(0,c.createRouteHandlerClient)({cookies:d.cookies}),{data:{user:r},error:s}=await t.auth.getUser();if(s||!r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=new URL(e.url),o=a.get("action"),i=parseInt(a.get("period")||"30"),u=new Date;switch(u.setDate(u.getDate()-i),o){case"user_dashboard":let[{data:l},{data:m},{data:p},{data:_},{data:g}]=await Promise.all([t.from("orders").select("total_amount").eq("user_id",r.id).eq("status","completed").gte("created_at",u.toISOString()),t.from("commissions").select("amount").eq("referrer_id",r.id).gte("created_at",u.toISOString()),t.from("warranties").select("id").eq("user_id",r.id).eq("status","active").gt("warranty_expiration",new Date().toISOString()),t.from("construction_contracts").select("id").or(`client_id.eq.${r.id},supervisor_id.eq.${r.id}`).eq("status","active"),t.from("orders").select("created_at, total_amount").eq("user_id",r.id).eq("status","completed").gte("created_at",u.toISOString()).order("created_at",{ascending:!0})]),q=l?.reduce((e,t)=>e+t.total_amount,0)||0,f=m?.reduce((e,t)=>e+t.amount,0)||0;return n.NextResponse.json({period:i,summary:{totalSpent:q,totalEarned:f,activeWarranties:p?.length||0,activeContracts:_?.length||0,purchaseCount:l?.length||0},trends:{purchases:g||[]}});case"store_dashboard":let{data:x,error:y}=await t.from("stores").select("id").eq("user_id",r.id).single();if(y||!x)return n.NextResponse.json({error:"Store not found"},{status:404});let[{data:v},{data:h},{data:S},{data:w}]=await Promise.all([t.from("orders").select("total_amount, created_at").eq("store_id",x.id).eq("status","completed").gte("created_at",u.toISOString()),t.from("orders").select("id, status").eq("store_id",x.id).gte("created_at",u.toISOString()),t.from("order_items").select(`
              global_item_id,
              quantity,
              global_items (name, image_url)
            `).eq("store_id",x.id).gte("created_at",u.toISOString()),t.from("store_inventory").select("quantity_available, price").eq("store_id",x.id)]),O=v?.reduce((e,t)=>e+t.total_amount,0)||0,j=h?.filter(e=>"pending"===e.status).length||0,I=h?.filter(e=>"completed"===e.status).length||0,b=S?.reduce((e,t)=>{let r=t.global_item_id;return e[r]||(e[r]={...t.global_items,totalSold:0}),e[r].totalSold+=t.quantity,e},{}),R=Object.values(b||{}).sort((e,t)=>t.totalSold-e.totalSold).slice(0,5);return n.NextResponse.json({period:i,summary:{totalRevenue:O,pendingOrders:j,completedOrders:I,totalOrders:h?.length||0,inventoryItems:w?.length||0,totalInventoryValue:w?.reduce((e,t)=>e+t.quantity_available*t.price,0)||0},topProducts:R,salesTrend:v||[]});case"commission_analytics":let[{data:k},{data:C},{data:N},{data:P}]=await Promise.all([t.from("commissions").select("amount, commission_type, created_at").eq("referrer_id",r.id).gte("created_at",u.toISOString()),t.from("invite_codes").select("code, type, usage_count, created_at").eq("created_by",r.id),t.from("commissions").select("id").eq("referrer_id",r.id).eq("commission_type","user_signup"),t.from("commissions").select("id").eq("referrer_id",r.id).eq("commission_type","store_signup")]),U=k?.reduce((e,t)=>(e[t.commission_type]||(e[t.commission_type]=0),e[t.commission_type]+=t.amount,e),{})||{};return n.NextResponse.json({period:i,summary:{totalCommissions:k?.reduce((e,t)=>e+t.amount,0)||0,activeInviteCodes:C?.length||0,referredUsers:N?.length||0,referredStores:P?.length||0},commissionsByType:U,commissionTrend:k||[],inviteCodes:C||[]});case"supervisor_analytics":let{data:D}=await t.from("construction_contracts").select("id, total_amount, status, created_at").eq("supervisor_id",r.id).gte("created_at",u.toISOString()),T=D?.map(e=>e.id)||[],[{data:A},{data:E},{data:F}]=await Promise.all([t.from("project_expenses").select("amount, status, expense_date").in("contract_id",T).gte("expense_date",u.toISOString()),t.from("payment_milestones").select("amount, completion_date").in("contract_id",T).eq("status","completed").gte("completion_date",u.toISOString()),t.from("project_workers").select("id, daily_rate").in("contract_id",T)]),M=D?.reduce((e,t)=>e+t.total_amount,0)||0,z=A?.reduce((e,t)=>e+t.amount,0)||0,H=E?.reduce((e,t)=>e+t.amount,0)||0;return n.NextResponse.json({period:i,summary:{activeContracts:D?.filter(e=>"active"===e.status).length||0,totalContractValue:M,totalExpenses:z,earnedFromMilestones:H,managedWorkers:F?.length||0},contracts:D||[],expenses:A||[],milestones:E||[]});default:return n.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return n.NextResponse.json({error:"Failed to fetch analytics data"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"C:\\Users\\hp\\BinnaCodes\\binna\\src\\app\\api\\analytics\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:p,serverHooks:_}=l;function g(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:p})}},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,580,9398,1223,4999],()=>r(87305));module.exports=s})();