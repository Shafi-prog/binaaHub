<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>اختبار تدفق تسجيل الدخول المحدث</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        direction: rtl;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        background: #f8f9fa;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 10px 5px;
        font-size: 14px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .btn.success {
        background: #28a745;
      }
      .btn.danger {
        background: #dc3545;
      }
      .btn.warning {
        background: #ffc107;
        color: #000;
      }
      .result {
        background: #e9ecef;
        padding: 15px;
        margin: 10px 0;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #007bff;
      }
      .warning {
        color: #ffc107;
      }
      .status {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        display: none;
      }
      .status.show {
        display: block;
      }
      .status.success {
        background: #28a745;
      }
      .status.error {
        background: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="status" id="status"></div>

    <div class="container">
      <h1>🧪 اختبار تدفق تسجيل الدخول المحدث</h1>

      <div class="test-section">
        <h3>🔐 اختبار المصادقة</h3>
        <p>اختبار تسجيل الدخول بالطريقة الجديدة (العميل مباشرة)</p>
        <button class="btn" onclick="testUserLogin()">🧑 اختبار تسجيل دخول المستخدم</button>
        <button class="btn" onclick="testStoreLogin()">🏪 اختبار تسجيل دخول المتجر</button>
        <button class="btn warning" onclick="clearResults()">🗑️ مسح النتائج</button>
        <div class="result" id="authResult"></div>
      </div>

      <div class="test-section">
        <h3>🔄 اختبار التوجيه</h3>
        <p>اختبار التوجيه بعد تسجيل الدخول</p>
        <button class="btn" onclick="testUserRedirect()">🧑 اختبار توجيه المستخدم</button>
        <button class="btn" onclick="testStoreRedirect()">🏪 اختبار توجيه المتجر</button>
        <button class="btn success" onclick="testDirectAccess()">🎯 اختبار الوصول المباشر</button>
        <div class="result" id="redirectResult"></div>
      </div>

      <div class="test-section">
        <h3>🛠️ أدوات التشخيص</h3>
        <p>أدوات للتحقق من حالة المصادقة</p>
        <button class="btn" onclick="checkCurrentAuth()">🔍 فحص المصادقة الحالية</button>
        <button class="btn" onclick="testRefreshEndpoint()">🔄 اختبار نقطة التحديث</button>
        <button class="btn" onclick="testMiddleware()">🛡️ اختبار الـ Middleware</button>
        <button class="btn danger" onclick="clearAuth()">🚪 مسح المصادقة</button>
        <div class="result" id="diagnosticResult"></div>
      </div>

      <div class="test-section">
        <h3>🎯 اختبار سريع شامل</h3>
        <p>اختبار كامل للتدفق الجديد</p>
        <button class="btn success" onclick="runFullTest()">🚀 تشغيل الاختبار الشامل</button>
        <div class="result" id="fullTestResult"></div>
      </div>
    </div>

    <script type="module">
      // Import Supabase client
      import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2.39.3';

      const supabaseUrl = 'https://lvnhakmdswjdozwkkmnl.supabase.co';
      const supabaseKey =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2bmhha21kc3dqZG96d2trbW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3OTI0NzgsImV4cCI6MjA1MjM2ODQ3OH0.nrQR69a4P1zlr5P3wE5qKyKDCXFTgDTRN7R4Lf04xCo';

      window.supabase = createClient(supabaseUrl, supabaseKey);

      // Make functions available globally
      window.testUserLogin = testUserLogin;
      window.testStoreLogin = testStoreLogin;
      window.testUserRedirect = testUserRedirect;
      window.testStoreRedirect = testStoreRedirect;
      window.testDirectAccess = testDirectAccess;
      window.checkCurrentAuth = checkCurrentAuth;
      window.testRefreshEndpoint = testRefreshEndpoint;
      window.testMiddleware = testMiddleware;
      window.clearAuth = clearAuth;
      window.clearResults = clearResults;
      window.runFullTest = runFullTest;

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ar-EG');
        const color =
          {
            success: 'success',
            error: 'error',
            info: 'info',
            warning: 'warning',
          }[type] || 'info';

        return `<div class="${color}">[${timestamp}] ${message}</div>`;
      }

      function showStatus(message, type = 'success') {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = `status show ${type}`;
        setTimeout(() => {
          status.classList.remove('show');
        }, 3000);
      }

      function appendToResult(resultId, content) {
        const result = document.getElementById(resultId);
        result.innerHTML += content;
        result.scrollTop = result.scrollHeight;
      }

      async function testUserLogin() {
        const resultId = 'authResult';
        appendToResult(resultId, log('🔐 بدء اختبار تسجيل دخول المستخدم...', 'info'));

        try {
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'user@user.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`❌ خطأ: ${error.message}`, 'error'));
            showStatus('فشل تسجيل دخول المستخدم', 'error');
            return;
          }

          appendToResult(resultId, log('✅ تم تسجيل الدخول بنجاح', 'success'));
          appendToResult(resultId, log(`👤 البريد الإلكتروني: ${data.user?.email}`, 'info'));
          appendToResult(
            resultId,
            log(`🔑 معرف الجلسة: ${data.session?.access_token?.substring(0, 20)}...`, 'info')
          );

          // Test getting user data
          const { data: userData, error: userError } = await window.supabase
            .from('users')
            .select('account_type')
            .eq('email', 'user@user.com')
            .single();

          if (userError) {
            appendToResult(
              resultId,
              log(`⚠️ تحذير: فشل في جلب بيانات المستخدم: ${userError.message}`, 'warning')
            );
          } else {
            appendToResult(resultId, log(`✅ نوع الحساب: ${userData.account_type}`, 'success'));
          }

          showStatus('تم تسجيل دخول المستخدم بنجاح', 'success');
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ عام: ${error.message}`, 'error'));
          showStatus('خطأ في تسجيل دخول المستخدم', 'error');
        }
      }

      async function testStoreLogin() {
        const resultId = 'authResult';
        appendToResult(resultId, log('🏪 بدء اختبار تسجيل دخول المتجر...', 'info'));

        try {
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'store@store.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`❌ خطأ: ${error.message}`, 'error'));
            showStatus('فشل تسجيل دخول المتجر', 'error');
            return;
          }

          appendToResult(resultId, log('✅ تم تسجيل الدخول بنجاح', 'success'));
          appendToResult(resultId, log(`🏪 البريد الإلكتروني: ${data.user?.email}`, 'info'));
          appendToResult(
            resultId,
            log(`🔑 معرف الجلسة: ${data.session?.access_token?.substring(0, 20)}...`, 'info')
          );

          // Test getting store data
          const { data: storeData, error: storeError } = await window.supabase
            .from('users')
            .select('account_type')
            .eq('email', 'store@store.com')
            .single();

          if (storeError) {
            appendToResult(
              resultId,
              log(`⚠️ تحذير: فشل في جلب بيانات المتجر: ${storeError.message}`, 'warning')
            );
          } else {
            appendToResult(resultId, log(`✅ نوع الحساب: ${storeData.account_type}`, 'success'));
          }

          showStatus('تم تسجيل دخول المتجر بنجاح', 'success');
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ عام: ${error.message}`, 'error'));
          showStatus('خطأ في تسجيل دخول المتجر', 'error');
        }
      }

      async function testUserRedirect() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('🔄 اختبار توجيه المستخدم...', 'info'));

        try {
          // First login
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'user@user.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`❌ فشل تسجيل الدخول: ${error.message}`, 'error'));
            return;
          }

          appendToResult(resultId, log('✅ تم تسجيل الدخول، جاري التوجيه...', 'success'));

          // Simulate the redirect
          await new Promise((resolve) => setTimeout(resolve, 1000));
          window.open('http://localhost:3004/user/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('🚀 تم فتح لوحة تحكم المستخدم في نافذة جديدة', 'info'));
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في التوجيه: ${error.message}`, 'error'));
        }
      }

      async function testStoreRedirect() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('🔄 اختبار توجيه المتجر...', 'info'));

        try {
          // First login
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: 'store@store.com',
            password: '123456',
          });

          if (error) {
            appendToResult(resultId, log(`❌ فشل تسجيل الدخول: ${error.message}`, 'error'));
            return;
          }

          appendToResult(resultId, log('✅ تم تسجيل الدخول، جاري التوجيه...', 'success'));

          // Simulate the redirect
          await new Promise((resolve) => setTimeout(resolve, 1000));
          window.open('http://localhost:3004/store/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('🚀 تم فتح لوحة تحكم المتجر في نافذة جديدة', 'info'));
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في التوجيه: ${error.message}`, 'error'));
        }
      }

      async function testDirectAccess() {
        const resultId = 'redirectResult';
        appendToResult(resultId, log('🎯 اختبار الوصول المباشر للصفحات المحمية...', 'info'));

        const pages = [
          { name: 'لوحة تحكم المستخدم', url: 'http://localhost:3004/user/dashboard' },
          { name: 'الملف الشخصي', url: 'http://localhost:3004/user/profile' },
          { name: 'المشاريع', url: 'http://localhost:3004/user/projects' },
          { name: 'لوحة تحكم المتجر', url: 'http://localhost:3004/store/dashboard' },
        ];

        for (const page of pages) {
          appendToResult(resultId, log(`🔗 فتح ${page.name}...`, 'info'));
          window.open(page.url, '_blank');
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        appendToResult(resultId, log('✅ تم فتح جميع الصفحات للاختبار', 'success'));
      }

      async function checkCurrentAuth() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('🔍 فحص حالة المصادقة الحالية...', 'info'));

        try {
          const {
            data: { session },
            error,
          } = await window.supabase.auth.getSession();

          if (error) {
            appendToResult(resultId, log(`❌ خطأ في الجلسة: ${error.message}`, 'error'));
            return;
          }

          if (session && session.user) {
            appendToResult(resultId, log('✅ توجد جلسة نشطة', 'success'));
            appendToResult(resultId, log(`👤 المستخدم: ${session.user.email}`, 'info'));
            appendToResult(
              resultId,
              log(
                `🕒 انتهاء الجلسة: ${new Date(session.expires_at * 1000).toLocaleString('ar-EG')}`,
                'info'
              )
            );

            // Check cookies
            const cookies = document.cookie.split(';').filter((c) => c.includes('sb-'));
            appendToResult(resultId, log(`🍪 عدد كوكيز Supabase: ${cookies.length}`, 'info'));
          } else {
            appendToResult(resultId, log('❌ لا توجد جلسة نشطة', 'error'));
          }
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في فحص المصادقة: ${error.message}`, 'error'));
        }
      }

      async function testRefreshEndpoint() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('🔄 اختبار نقطة تحديث المصادقة...', 'info'));

        try {
          const response = await fetch('http://localhost:3004/api/auth/refresh', {
            method: 'GET',
            credentials: 'include',
          });

          const data = await response.json();

          if (response.ok) {
            appendToResult(resultId, log('✅ تم تحديث المصادقة بنجاح', 'success'));
            appendToResult(resultId, log(`📊 البيانات: ${JSON.stringify(data, null, 2)}`, 'info'));
          } else {
            appendToResult(resultId, log(`❌ فشل تحديث المصادقة: ${data.error}`, 'error'));
          }
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في نقطة التحديث: ${error.message}`, 'error'));
        }
      }

      async function testMiddleware() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('🛡️ اختبار الـ Middleware...', 'info'));

        const testUrls = [
          'http://localhost:3004/auth-diagnostic',
          'http://localhost:3004/auth-check',
        ];

        for (const url of testUrls) {
          try {
            appendToResult(resultId, log(`🔗 اختبار: ${url}`, 'info'));
            window.open(url, '_blank');
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            appendToResult(resultId, log(`❌ خطأ في ${url}: ${error.message}`, 'error'));
          }
        }

        appendToResult(resultId, log('✅ تم فتح صفحات التشخيص', 'success'));
      }

      async function clearAuth() {
        const resultId = 'diagnosticResult';
        appendToResult(resultId, log('🚪 مسح المصادقة...', 'info'));

        try {
          await window.supabase.auth.signOut();
          appendToResult(resultId, log('✅ تم تسجيل الخروج بنجاح', 'success'));

          // Clear cookies
          document.cookie.split(';').forEach(function (c) {
            document.cookie = c
              .replace(/^ +/, '')
              .replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/');
          });

          appendToResult(resultId, log('🍪 تم مسح الكوكيز', 'info'));
          showStatus('تم مسح المصادقة', 'success');
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في مسح المصادقة: ${error.message}`, 'error'));
          showStatus('خطأ في مسح المصادقة', 'error');
        }
      }

      function clearResults() {
        document.querySelectorAll('.result').forEach((result) => {
          result.innerHTML = '';
        });
        showStatus('تم مسح النتائج', 'success');
      }

      async function runFullTest() {
        const resultId = 'fullTestResult';
        appendToResult(resultId, log('🚀 بدء الاختبار الشامل...', 'info'));

        try {
          // Step 1: Clear any existing auth
          await window.supabase.auth.signOut();
          appendToResult(resultId, log('🧹 تم مسح المصادقة السابقة', 'info'));

          // Step 2: Test user login
          appendToResult(resultId, log('🔐 اختبار تسجيل دخول المستخدم...', 'info'));
          const { data: userData, error: userError } =
            await window.supabase.auth.signInWithPassword({
              email: 'user@user.com',
              password: '123456',
            });

          if (userError) {
            appendToResult(
              resultId,
              log(`❌ فشل تسجيل دخول المستخدم: ${userError.message}`, 'error')
            );
            return;
          }

          appendToResult(resultId, log('✅ تم تسجيل دخول المستخدم بنجاح', 'success'));

          // Step 3: Test refresh endpoint
          appendToResult(resultId, log('🔄 اختبار نقطة التحديث...', 'info'));
          try {
            const refreshResponse = await fetch('http://localhost:3004/api/auth/refresh', {
              method: 'GET',
              credentials: 'include',
            });

            if (refreshResponse.ok) {
              const refreshData = await refreshResponse.json();
              appendToResult(
                resultId,
                log(
                  `✅ نقطة التحديث تعمل: ${refreshData.authenticated ? 'مصادق' : 'غير مصادق'}`,
                  'success'
                )
              );
            } else {
              appendToResult(resultId, log('⚠️ نقطة التحديث لا تعمل كما متوقع', 'warning'));
            }
          } catch (refreshError) {
            appendToResult(
              resultId,
              log(`⚠️ خطأ في نقطة التحديث: ${refreshError.message}`, 'warning')
            );
          }

          // Step 4: Test redirect simulation
          appendToResult(resultId, log('🚀 محاكاة التوجيه بعد تسجيل الدخول...', 'info'));
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Open dashboard with post_login parameter
          window.open('http://localhost:3004/user/dashboard?post_login=true', '_blank');
          appendToResult(resultId, log('✅ تم فتح لوحة التحكم مع معامل post_login', 'success'));

          // Step 5: Test store login
          appendToResult(resultId, log('🏪 اختبار تسجيل دخول المتجر...', 'info'));
          const { data: storeData, error: storeError } =
            await window.supabase.auth.signInWithPassword({
              email: 'store@store.com',
              password: '123456',
            });

          if (storeError) {
            appendToResult(
              resultId,
              log(`❌ فشل تسجيل دخول المتجر: ${storeError.message}`, 'error')
            );
          } else {
            appendToResult(resultId, log('✅ تم تسجيل دخول المتجر بنجاح', 'success'));

            // Open store dashboard
            await new Promise((resolve) => setTimeout(resolve, 1000));
            window.open('http://localhost:3004/store/dashboard?post_login=true', '_blank');
            appendToResult(resultId, log('✅ تم فتح لوحة تحكم المتجر', 'success'));
          }

          appendToResult(resultId, log('🎉 تم الانتهاء من الاختبار الشامل بنجاح!', 'success'));
          showStatus('تم الانتهاء من الاختبار بنجاح', 'success');
        } catch (error) {
          appendToResult(resultId, log(`❌ خطأ في الاختبار الشامل: ${error.message}`, 'error'));
          showStatus('فشل الاختبار الشامل', 'error');
        }
      }

      // Initial status check
      window.addEventListener('load', () => {
        showStatus('جاهز للاختبار', 'success');
      });
    </script>
  </body>
</html>
