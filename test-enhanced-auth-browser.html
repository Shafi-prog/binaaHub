<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Auth Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .test-section {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        border-color: #4caf50;
        background-color: #f0fff0;
      }
      .error {
        border-color: #f44336;
        background-color: #fff0f0;
      }
      .warning {
        border-color: #ff9800;
        background-color: #fff8e1;
      }
      .info {
        border-color: #2196f3;
        background-color: #e3f2fd;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .results {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      input {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .status {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 4px;
        margin: 5px 0;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .status.warning {
        background-color: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Enhanced Authentication Fix Test</h1>
      <p>
        This test validates the enhanced middleware and login API fixes for the authentication
        issues.
      </p>
    </div>

    <div class="container">
      <h2>üìã Test Configuration</h2>
      <div class="test-section info">
        <h3>Test User Credentials</h3>
        <input type="email" id="testEmail" placeholder="Test user email" value="" />
        <input type="password" id="testPassword" placeholder="Test user password" value="" />
        <button onclick="saveCredentials()">Save Credentials</button>
        <p><small>Enter valid test user credentials or create a new user if needed.</small></p>
      </div>
    </div>

    <div class="container">
      <h2>üîê Authentication Flow Tests</h2>

      <div class="test-section" id="loginTest">
        <h3>1. Enhanced Login API Test</h3>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResults" class="results"></div>
      </div>

      <div class="test-section" id="authStateTest">
        <h3>2. Server-Side Auth State Test</h3>
        <button onclick="testAuthState()">Check Auth State</button>
        <div id="authResults" class="results"></div>
      </div>

      <div class="test-section" id="newProjectTest">
        <h3>3. New Project Route Test (The Main Issue)</h3>
        <button onclick="testNewProjectRoute()">Test /user/projects/new</button>
        <div id="newProjectResults" class="results"></div>
      </div>

      <div class="test-section" id="dashboardTest">
        <h3>4. Dashboard Access Test</h3>
        <button onclick="testDashboard()">Test Dashboard</button>
        <div id="dashboardResults" class="results"></div>
      </div>

      <div class="test-section" id="cookieTest">
        <h3>5. Cookie Synchronization Test</h3>
        <button onclick="testCookies()">Check Cookies</button>
        <div id="cookieResults" class="results"></div>
      </div>
    </div>

    <div class="container">
      <h2>üìä Test Summary</h2>
      <div id="testSummary" class="test-section">
        <p>Run the tests above to see the overall status.</p>
      </div>
    </div>

    <script>
      let testCredentials = {
        email: '',
        password: '',
      };

      let testResults = {
        login: null,
        authState: null,
        newProject: null,
        dashboard: null,
        cookies: null,
      };

      function saveCredentials() {
        testCredentials.email = document.getElementById('testEmail').value;
        testCredentials.password = document.getElementById('testPassword').value;

        if (testCredentials.email && testCredentials.password) {
          alert('‚úÖ Credentials saved! You can now run the tests.');
        } else {
          alert('‚ùå Please enter both email and password.');
        }
      }

      async function testLogin() {
        const resultsDiv = document.getElementById('loginResults');
        resultsDiv.textContent = 'üîÑ Testing login API...';

        if (!testCredentials.email || !testCredentials.password) {
          resultsDiv.textContent = '‚ùå Please set credentials first';
          return;
        }

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(testCredentials),
          });

          const data = await response.json();
          testResults.login = { success: data.success, data };

          resultsDiv.textContent = `Login Response:\nStatus: ${response.status}\nSuccess: ${data.success}\nData: ${JSON.stringify(data, null, 2)}`;

          if (data.success) {
            document.getElementById('loginTest').className = 'test-section success';
          } else {
            document.getElementById('loginTest').className = 'test-section error';
          }
        } catch (error) {
          testResults.login = { success: false, error: error.message };
          resultsDiv.textContent = `‚ùå Login Error: ${error.message}`;
          document.getElementById('loginTest').className = 'test-section error';
        }

        updateSummary();
      }

      async function testAuthState() {
        const resultsDiv = document.getElementById('authResults');
        resultsDiv.textContent = 'üîÑ Checking server-side auth state...';

        try {
          const response = await fetch('/api/debug-auth');
          const data = await response.json();
          testResults.authState = { success: !!data.hasSession, data };

          resultsDiv.textContent = `Auth State:\nStatus: ${response.status}\nHas Session: ${data.hasSession}\nHas User: ${data.hasUser}\nData: ${JSON.stringify(data, null, 2)}`;

          if (data.hasSession) {
            document.getElementById('authStateTest').className = 'test-section success';
          } else {
            document.getElementById('authStateTest').className = 'test-section warning';
          }
        } catch (error) {
          testResults.authState = { success: false, error: error.message };
          resultsDiv.textContent = `‚ùå Auth State Error: ${error.message}`;
          document.getElementById('authStateTest').className = 'test-section error';
        }

        updateSummary();
      }

      async function testNewProjectRoute() {
        const resultsDiv = document.getElementById('newProjectResults');
        resultsDiv.textContent = 'üîÑ Testing /user/projects/new route...';

        try {
          const response = await fetch('/user/projects/new', {
            redirect: 'manual',
          });

          const isAccessible = response.status === 200;
          const isRedirect = response.status === 307 || response.status === 302;
          const redirectLocation = response.headers.get('location');

          testResults.newProject = {
            success: isAccessible,
            status: response.status,
            redirected: isRedirect,
            location: redirectLocation,
          };

          resultsDiv.textContent = `New Project Route Test:\nStatus: ${response.status}\nAccessible: ${isAccessible}\nRedirected: ${isRedirect}\nLocation: ${redirectLocation || 'None'}\n\nThis is the MAIN ISSUE we're trying to fix!`;

          if (isAccessible) {
            document.getElementById('newProjectTest').className = 'test-section success';
          } else if (isRedirect && redirectLocation?.includes('/login')) {
            document.getElementById('newProjectTest').className = 'test-section error';
          } else {
            document.getElementById('newProjectTest').className = 'test-section warning';
          }
        } catch (error) {
          testResults.newProject = { success: false, error: error.message };
          resultsDiv.textContent = `‚ùå New Project Route Error: ${error.message}`;
          document.getElementById('newProjectTest').className = 'test-section error';
        }

        updateSummary();
      }

      async function testDashboard() {
        const resultsDiv = document.getElementById('dashboardResults');
        resultsDiv.textContent = 'üîÑ Testing dashboard access...';

        try {
          const response = await fetch('/user/dashboard', {
            redirect: 'manual',
          });

          const isAccessible = response.status === 200;
          const isRedirect = response.status === 307 || response.status === 302;
          const redirectLocation = response.headers.get('location');

          testResults.dashboard = {
            success: isAccessible,
            status: response.status,
            redirected: isRedirect,
            location: redirectLocation,
          };

          resultsDiv.textContent = `Dashboard Test:\nStatus: ${response.status}\nAccessible: ${isAccessible}\nRedirected: ${isRedirect}\nLocation: ${redirectLocation || 'None'}`;

          if (isAccessible) {
            document.getElementById('dashboardTest').className = 'test-section success';
          } else {
            document.getElementById('dashboardTest').className = 'test-section error';
          }
        } catch (error) {
          testResults.dashboard = { success: false, error: error.message };
          resultsDiv.textContent = `‚ùå Dashboard Error: ${error.message}`;
          document.getElementById('dashboardTest').className = 'test-section error';
        }

        updateSummary();
      }

      function testCookies() {
        const resultsDiv = document.getElementById('cookieResults');

        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
          const [key, value] = cookie.trim().split('=');
          if (key) acc[key] = value;
          return acc;
        }, {});

        const authCookies = Object.keys(cookies).filter(
          (key) =>
            key.includes('sb-') ||
            key.includes('supabase') ||
            key.includes('auth') ||
            key.includes('user_') ||
            key.includes('just_logged_in'),
        );

        testResults.cookies = {
          success: authCookies.length > 0,
          total: Object.keys(cookies).length,
          authCookies: authCookies.length,
        };

        resultsDiv.textContent = `Cookie Analysis:\nTotal Cookies: ${Object.keys(cookies).length}\nAuth-related Cookies: ${authCookies.length}\n\nAuth Cookies Found:\n${authCookies.map((key) => `- ${key}: ${cookies[key]?.substring(0, 30)}...`).join('\n') || 'None'}\n\nAll Cookies:\n${Object.keys(
          cookies,
        )
          .map((key) => `- ${key}: ${cookies[key]?.substring(0, 20)}...`)
          .join('\n')}`;

        if (authCookies.length > 0) {
          document.getElementById('cookieTest').className = 'test-section success';
        } else {
          document.getElementById('cookieTest').className = 'test-section warning';
        }

        updateSummary();
      }

      function updateSummary() {
        const summaryDiv = document.getElementById('testSummary');

        const results = [
          { name: 'Login API', result: testResults.login },
          { name: 'Auth State', result: testResults.authState },
          { name: 'New Project Route', result: testResults.newProject },
          { name: 'Dashboard Access', result: testResults.dashboard },
          { name: 'Cookie Sync', result: testResults.cookies },
        ];

        let summary = 'Test Results Summary:\n\n';
        let allPassed = true;
        let mainIssueSolved = false;

        results.forEach(({ name, result }) => {
          if (result) {
            const status = result.success ? '‚úÖ' : '‚ùå';
            summary += `${status} ${name}: ${result.success ? 'PASS' : 'FAIL'}\n`;
            if (!result.success) allPassed = false;
            if (name === 'New Project Route' && result.success) mainIssueSolved = true;
          } else {
            summary += `‚ö™ ${name}: Not tested\n`;
            allPassed = false;
          }
        });

        summary += '\n';
        if (mainIssueSolved) {
          summary += 'üéâ MAIN ISSUE SOLVED: New Project route is now accessible!\n';
        } else if (testResults.newProject && !testResults.newProject.success) {
          summary += 'üö® MAIN ISSUE PERSISTS: New Project route still redirects to login\n';
        }

        if (allPassed && mainIssueSolved) {
          summary += '‚úÖ ALL TESTS PASSED - Authentication fix is working!\n';
          summaryDiv.className = 'test-section success';
        } else {
          summary += '‚ö†Ô∏è Some tests failed - needs further investigation\n';
          summaryDiv.className = 'test-section warning';
        }

        summaryDiv.textContent = summary;
      } // Auto-fill some common test credentials
      document.getElementById('testEmail').value = 'user@user.com';
      document.getElementById('testPassword').value = '123456';
    </script>
  </body>
</html>
